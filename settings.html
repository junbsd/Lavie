<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lavie Spa - CÃ i Ä‘áº·t</title>
<script src="db.js"></script>
<style>
:root{
  --bg:#F5F7FA;--card:#fff;--border:#E2E8F0;--brown:#3E2310;--brown2:#5C3A1A;
  --gold:#96621A;--gold-mid:#B87D2E;--green:#16A34A;--green-light:#DCFCE7;
  --red:#DC2626;--red-light:#FEE2E2;--blue:#2563EB;--blue-light:#DBEAFE;
  --yellow:#D97706;--yellow-light:#FEF3C7;--text:#1E293B;--text2:#475569;--text3:#94A3B8;
  --shadow:rgba(0,0,0,0.06);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans','Segoe UI',sans-serif;min-height:100vh;}
.topbar{background:var(--brown);padding:11px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.topbar-logo{font-size:15px;font-weight:700;color:#E8C878;}
.topbar-nav{display:flex;gap:4px;}
.tnav{color:rgba(255,255,255,0.7);font-size:11px;padding:5px 10px;border-radius:12px;text-decoration:none;border:1px solid transparent;}
.tnav:hover,.tnav.active{background:rgba(255,255,255,0.15);color:#fff;}

.page-tabs{background:#fff;border-bottom:2px solid var(--border);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 4px;}
.page-tabs::-webkit-scrollbar{display:none;}
.ptab{flex-shrink:0;padding:11px 16px;font-size:12.5px;font-weight:600;color:var(--text2);cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;transition:all 0.2s;}
.ptab.active{color:var(--gold);border-bottom-color:var(--gold);}

.page-content{padding:14px;max-width:600px;margin:0 auto;display:none;}
.page-content.active{display:block;}

/* CARDS */
.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 6px var(--shadow);border:1px solid var(--border);}
.card-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}

/* LIST ITEMS */
.list-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);gap:8px;}
.list-item:last-child{border-bottom:none;}
.li-info{flex:1;}
.li-name{font-size:13.5px;font-weight:700;color:var(--text);}
.li-sub{font-size:11px;color:var(--text3);margin-top:2px;}
.li-actions{display:flex;gap:6px;}

/* BUTTONS */
.btn-icon{width:32px;height:32px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.15s;}
.btn-edit{background:var(--blue-light);color:var(--blue);}
.btn-delete{background:var(--red-light);color:var(--red);}
.btn-toggle{background:var(--yellow-light);color:var(--yellow);}
.btn-add{width:100%;padding:10px;border-radius:9px;background:var(--gold);color:#fff;font-size:13px;font-weight:700;border:none;cursor:pointer;margin-top:8px;transition:all 0.2s;}
.btn-add:hover{background:var(--brown2);}
.btn-danger{background:var(--red-light);color:var(--red);border:1.5px solid var(--red);padding:9px 16px;border-radius:9px;font-size:13px;font-weight:600;cursor:pointer;}
.btn-success{background:var(--green-light);color:var(--green);border:1.5px solid var(--green);padding:9px 16px;border-radius:9px;font-size:13px;font-weight:600;cursor:pointer;}
.btn-blue{background:var(--blue-light);color:var(--blue);border:1.5px solid var(--blue);padding:9px 16px;border-radius:9px;font-size:13px;font-weight:600;cursor:pointer;}

/* FORM */
.field-label{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:4px;margin-top:10px;}
.field-input,.field-select,.field-textarea{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;color:var(--text);background:var(--card);}
.field-textarea{resize:vertical;min-height:60px;}
.field-input:focus,.field-select:focus,.field-textarea:focus{outline:none;border-color:var(--gold);}
.price-row-form{display:flex;gap:8px;align-items:center;margin-bottom:6px;}
.price-row-form input{flex:1;padding:7px 9px;border:1.5px solid var(--border);border-radius:7px;font-size:12px;}
.price-row-form .del-price{background:var(--red-light);color:var(--red);border:none;border-radius:6px;padding:5px 8px;cursor:pointer;font-size:12px;}
.add-price-btn{padding:6px 12px;border-radius:7px;background:var(--blue-light);color:var(--blue);border:1px solid var(--blue);font-size:12px;cursor:pointer;margin-top:4px;}

/* TRANSLATE STATUS */
.translate-status{font-size:11px;padding:4px 8px;border-radius:6px;margin-top:6px;display:none;}
.translate-status.loading{background:var(--yellow-light);color:var(--yellow);display:block;}
.translate-status.done{background:var(--green-light);color:var(--green);display:block;}
.translate-status.error{background:var(--red-light);color:var(--red);display:block;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:500;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-box{background:#fff;border-radius:20px 20px 0 0;padding:20px;width:100%;max-width:540px;max-height:92vh;overflow-y:auto;animation:slideUp 0.28s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-title{font-size:17px;font-weight:700;color:var(--text);margin-bottom:14px;}
.btn-row{display:flex;gap:8px;margin-top:14px;}
.btn-primary{flex:1;padding:11px;border-radius:9px;background:var(--gold);color:#fff;font-size:14px;font-weight:700;border:none;cursor:pointer;}
.btn-secondary{flex:1;padding:11px;border-radius:9px;background:var(--bg);color:var(--text2);font-size:14px;font-weight:600;border:1.5px solid var(--border);cursor:pointer;}

/* BACKUP SECTION */
.backup-row{display:flex;gap:8px;flex-wrap:wrap;}
.chip{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;}
.chip-gold{background:var(--gold);color:#fff;}
.chip-blue{background:var(--blue-light);color:var(--blue);border:1px solid var(--blue);}
.chip-green{background:var(--green-light);color:var(--green);border:1px solid var(--green);}
.chip-red{background:var(--red-light);color:var(--red);border:1px solid var(--red);}

/* NOTE SEARCH */
.search-input{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;font-size:13px;margin-bottom:10px;}
.search-input:focus{outline:none;border-color:var(--gold);}
.note-result{background:var(--card);border-radius:9px;padding:10px 12px;margin-bottom:7px;border:1px solid var(--border);}
.nr-menu{font-size:13px;font-weight:700;color:var(--text);}
.nr-meta{font-size:11px;color:var(--text3);margin-top:2px;}
.nr-note{font-size:12px;color:var(--blue);margin-top:4px;padding:5px 7px;background:var(--blue-light);border-radius:6px;}
.highlight{background:#FFF3A3;padding:1px 2px;border-radius:3px;}

.tag{display:inline-block;padding:2px 7px;border-radius:6px;font-size:10px;font-weight:700;margin-left:4px;}
.tag-active{background:var(--green-light);color:var(--green);}
.tag-inactive{background:var(--border);color:var(--text3);}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-logo">ğŸŒ¿ Lavie Spa - CÃ i Ä‘áº·t</div>
  <div class="topbar-nav">
    <a class="tnav" href="index.html">ğŸ“‹ Menu</a>
    <a class="tnav" href="admin.html">âš™ï¸ Quáº£n lÃ½</a>
    <a class="tnav active" href="settings.html">ğŸ›  CÃ i Ä‘áº·t</a>
  </div>
</div>

<div class="page-tabs">
  <div class="ptab active" onclick="showPage('therapists')">ğŸ‘¤ KTV</div>
  <div class="ptab" onclick="showPage('menus')">ğŸ“‹ Menu</div>
  <div class="ptab" onclick="showPage('categories')">ğŸ—‚ Danh má»¥c</div>
  <div class="ptab" onclick="showPage('notes')">ğŸ” Ghi chÃº</div>
  <div class="ptab" onclick="showPage('backup')">ğŸ’¾ Sao lÆ°u</div>
</div>

<!-- THERAPISTS -->
<div id="page-therapists" class="page-content active">
  <div class="card">
    <div class="card-title">Danh sÃ¡ch ká»¹ thuáº­t viÃªn
      <button class="btn-icon btn-edit" onclick="openTherapistModal()">+</button>
    </div>
    <div id="therapistList"></div>
    <button class="btn-add" onclick="openTherapistModal()">+ ThÃªm ká»¹ thuáº­t viÃªn</button>
  </div>
</div>

<!-- MENUS -->
<div id="page-menus" class="page-content">
  <div class="card" style="padding:10px 14px;">
    <div class="field-label" style="margin-top:0">Lá»c theo danh má»¥c</div>
    <select class="field-select" id="menuCatFilter" onchange="renderMenuList()">
      <option value="">-- Táº¥t cáº£ danh má»¥c --</option>
    </select>
  </div>
  <div id="menuList"></div>
  <button class="btn-add" onclick="openMenuModal()">+ ThÃªm dá»‹ch vá»¥ má»›i</button>
</div>

<!-- CATEGORIES -->
<div id="page-categories" class="page-content">
  <div class="card">
    <div class="card-title">Danh má»¥c dá»‹ch vá»¥
      <button class="btn-icon btn-edit" onclick="openCatModal()">+</button>
    </div>
    <div id="catList"></div>
    <button class="btn-add" onclick="openCatModal()">+ ThÃªm danh má»¥c</button>
  </div>
</div>

<!-- NOTE SEARCH -->
<div id="page-notes" class="page-content">
  <div class="card">
    <div class="card-title">ğŸ” TÃ¬m kiáº¿m ghi chÃº</div>
    <input class="search-input" type="text" id="noteSearch" placeholder="Nháº­p tá»« khÃ³a tÃ¬m kiáº¿m..." oninput="searchNotes()">
    <div id="noteResults"></div>
  </div>
</div>

<!-- BACKUP -->
<div id="page-backup" class="page-content">
  <div class="card">
    <div class="card-title">ğŸ’¾ Sao lÆ°u & KhÃ´i phá»¥c</div>
    <div class="backup-row" style="margin-bottom:12px;">
      <button class="chip chip-gold" onclick="doBackup()">ğŸ“¦ Sao lÆ°u JSON</button>
      <label class="chip chip-green" style="cursor:pointer;">
        ğŸ“‚ KhÃ´i phá»¥c JSON <input type="file" accept=".json" style="display:none" onchange="doRestore(this)">
      </label>
    </div>
    <p style="font-size:12px;color:var(--text3);">Sao lÆ°u toÃ n bá»™ dá»¯ liá»‡u gá»“m menu, KTV, lá»‹ch sá»­ vÃ  cÃ i Ä‘áº·t.</p>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“¥ Xuáº¥t dá»¯ liá»‡u Excel (CSV)</div>
    <div class="backup-row">
      <button class="chip chip-blue" onclick="exportAll('records')">ğŸ“‹ Lá»‹ch sá»­ dá»‹ch vá»¥</button>
      <button class="chip chip-blue" onclick="exportAll('menus')">ğŸ—’ Danh sÃ¡ch menu</button>
      <button class="chip chip-blue" onclick="exportAll('therapists')">ğŸ‘¥ KTV</button>
    </div>
  </div>

  <div class="card">
    <div class="card-title" style="color:var(--red);">âš ï¸ Nguy hiá»ƒm</div>
    <p style="font-size:12px;color:var(--text3);margin-bottom:10px;">XÃ³a toÃ n bá»™ dá»¯ liá»‡u vÃ  khá»Ÿi Ä‘á»™ng láº¡i tá»« Ä‘áº§u. KhÃ´ng thá»ƒ hoÃ n tÃ¡c!</p>
    <button class="btn-danger" onclick="resetDB()">ğŸ—‘ XÃ³a toÃ n bá»™ dá»¯ liá»‡u</button>
  </div>
</div>

<!-- Therapist Modal -->
<div class="modal-overlay" id="therapistModal">
  <div class="modal-box">
    <div class="modal-title" id="thrModalTitle">ThÃªm ká»¹ thuáº­t viÃªn</div>
    <input type="hidden" id="thrId">
    <div class="field-label">TÃªn (báº¯t buá»™c) *</div>
    <input class="field-input" id="thrName" type="text" placeholder="TÃªn KTV...">
    <div class="field-label">Sá»‘ Ä‘iá»‡n thoáº¡i</div>
    <input class="field-input" id="thrPhone" type="tel" placeholder="0901...">
    <div class="field-label">TÃ i khoáº£n ngÃ¢n hÃ ng</div>
    <input class="field-input" id="thrBank" type="text" placeholder="MB Bank - 012345678">
    <div class="btn-row">
      <button class="btn-secondary" onclick="closeThrModal()">Há»§y</button>
      <button class="btn-primary" onclick="saveThr()">ğŸ’¾ LÆ°u</button>
    </div>
  </div>
</div>

<!-- Menu Modal -->
<div class="modal-overlay" id="menuModal">
  <div class="modal-box">
    <div class="modal-title" id="menuModalTitle">ThÃªm dá»‹ch vá»¥</div>
    <input type="hidden" id="menuId">
    <div class="field-label">Danh má»¥c *</div>
    <select class="field-select" id="menuCatId"></select>
    <div class="field-label">TÃªn dá»‹ch vá»¥ (Tiáº¿ng Viá»‡t) *</div>
    <input class="field-input" id="menuNameVi" type="text" placeholder="TÃªn dá»‹ch vá»¥ báº±ng tiáº¿ng Viá»‡t...">
    <div class="field-label">MÃ´ táº£ (Tiáº¿ng Viá»‡t)</div>
    <textarea class="field-textarea" id="menuDescVi" placeholder="NgÃ¢m chÃ¢n tháº£o dÆ°á»£c + massage..."></textarea>
    <div class="field-label">GiÃ¡ dá»‹ch vá»¥</div>
    <div id="priceRows"></div>
    <button class="add-price-btn" onclick="addPriceRow()">+ ThÃªm má»©c giÃ¡</button>
    <div class="translate-status" id="translateStatus">ğŸ”„ Äang dá»‹ch tá»± Ä‘á»™ng...</div>
    <div class="btn-row">
      <button class="btn-secondary" onclick="closeMenuModal()">Há»§y</button>
      <button class="btn-primary" onclick="saveMenu()">ğŸ’¾ LÆ°u & Dá»‹ch</button>
    </div>
  </div>
</div>

<!-- Category Modal -->
<div class="modal-overlay" id="catModal">
  <div class="modal-box">
    <div class="modal-title" id="catModalTitle">ThÃªm danh má»¥c</div>
    <input type="hidden" id="catId">
    <div class="field-label">TÃªn danh má»¥c (Tiáº¿ng Viá»‡t) *</div>
    <input class="field-input" id="catNameVi" type="text" placeholder="VD: Massage Trá»‹ Liá»‡u...">
    <div class="field-label">Icon (emoji)</div>
    <input class="field-input" id="catIcon" type="text" placeholder="ğŸ’†" maxlength="4">
    <div class="translate-status" id="catTranslateStatus"></div>
    <div class="btn-row">
      <button class="btn-secondary" onclick="closeCatModal()">Há»§y</button>
      <button class="btn-primary" onclick="saveCat()">ğŸ’¾ LÆ°u</button>
    </div>
  </div>
</div>

<script>
let db;

function init() {
  db = DB.loadDB();
  renderTherapists();
  renderMenuList();
  renderCatList();
  populateCatSelects();
}

function showPage(name) {
  document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name)?.classList.add('active');
  document.querySelectorAll('.ptab').forEach((t,i) => {
    t.classList.toggle('active', ['therapists','menus','categories','notes','backup'][i] === name);
  });
  if (name === 'notes') { document.getElementById('noteSearch').value = ''; searchNotes(); }
}

// â”€â”€ THERAPISTS â”€â”€
function renderTherapists() {
  const el = document.getElementById('therapistList');
  if (db.therapists.length === 0) { el.innerHTML = '<p style="color:var(--text3);font-size:13px;">ChÆ°a cÃ³ KTV nÃ o.</p>'; return; }
  el.innerHTML = db.therapists.map(t => `
    <div class="list-item">
      <div class="li-info">
        <div class="li-name">${t.name} <span class="tag ${t.active !== false ? 'tag-active':'tag-inactive'}">${t.active !== false ?'Hoáº¡t Ä‘á»™ng':'Nghá»‰'}</span></div>
        <div class="li-sub">${t.phone||''} ${t.bank ? '| '+t.bank : ''}</div>
      </div>
      <div class="li-actions">
        <button class="btn-icon btn-toggle" onclick="toggleThr('${t.id}')" title="Báº­t/Táº¯t">â¸</button>
        <button class="btn-icon btn-edit" onclick="openTherapistModal('${t.id}')">âœï¸</button>
        <button class="btn-icon btn-delete" onclick="deleteThr('${t.id}')">ğŸ—‘</button>
      </div>
    </div>`).join('');
}

function openTherapistModal(id) {
  document.getElementById('thrModalTitle').textContent = id ? 'Sá»­a ká»¹ thuáº­t viÃªn' : 'ThÃªm ká»¹ thuáº­t viÃªn';
  const t = id ? db.therapists.find(t => t.id === id) : null;
  document.getElementById('thrId').value = id || '';
  document.getElementById('thrName').value = t?.name || '';
  document.getElementById('thrPhone').value = t?.phone || '';
  document.getElementById('thrBank').value = t?.bank || '';
  document.getElementById('therapistModal').classList.add('show');
}
function closeThrModal() { document.getElementById('therapistModal').classList.remove('show'); }
function saveThr() {
  const name = document.getElementById('thrName').value.trim();
  if (!name) { alert('Vui lÃ²ng nháº­p tÃªn KTV!'); return; }
  const id = document.getElementById('thrId').value;
  db = DB.loadDB();
  if (id) {
    const idx = db.therapists.findIndex(t => t.id === id);
    if (idx !== -1) { db.therapists[idx].name = name; db.therapists[idx].phone = document.getElementById('thrPhone').value; db.therapists[idx].bank = document.getElementById('thrBank').value; }
  } else {
    db.therapists.push({ id: DB.genId('t'), name, phone: document.getElementById('thrPhone').value, bank: document.getElementById('thrBank').value, active: true });
  }
  DB.saveDB(db); closeThrModal(); renderTherapists();
}
function toggleThr(id) {
  db = DB.loadDB();
  const t = db.therapists.find(t => t.id === id);
  if (t) { t.active = t.active === false ? true : false; DB.saveDB(db); renderTherapists(); }
}
function deleteThr(id) {
  if (!confirm('XÃ³a KTV nÃ y?')) return;
  db = DB.loadDB();
  db.therapists = db.therapists.filter(t => t.id !== id);
  DB.saveDB(db); renderTherapists();
}

// â”€â”€ MENUS â”€â”€
function populateCatSelects() {
  const opts = db.categories.map(c => `<option value="${c.id}">${c.icon} ${c.nameVi}</option>`).join('');
  document.getElementById('menuCatFilter').innerHTML = '<option value="">-- Táº¥t cáº£ --</option>' + opts;
  document.getElementById('menuCatId').innerHTML = '<option value="">-- Chá»n danh má»¥c --</option>' + opts;
}

function renderMenuList() {
  const catFilter = document.getElementById('menuCatFilter')?.value || '';
  const menus = catFilter ? db.menus.filter(m => m.catId === catFilter) : db.menus;
  const el = document.getElementById('menuList');
  if (menus.length === 0) { el.innerHTML = '<div class="card" style="text-align:center;color:var(--text3)">ChÆ°a cÃ³ dá»‹ch vá»¥.</div>'; return; }

  // Group by category
  const grouped = {};
  menus.forEach(m => {
    const cat = db.categories.find(c => c.id === m.catId);
    const key = cat ? cat.nameVi : 'KhÃ¡c';
    if (!grouped[key]) grouped[key] = { cat, items: [] };
    grouped[key].items.push(m);
  });

  el.innerHTML = Object.entries(grouped).map(([catName, { cat, items }]) => `
    <div class="card">
      <div class="card-title">${cat?.icon||''} ${catName}</div>
      ${items.map(m => `
        <div class="list-item">
          <div class="li-info">
            <div class="li-name">${m.nameVi} <span class="tag ${m.active?'tag-active':'tag-inactive'}">${m.active?'Hiá»‡n':'áº¨n'}</span></div>
            <div class="li-sub">${m.prices.map(p=>(p.duration?p.duration+'ph ':'')+DB.fmtMoney(p.amount)).join(' | ')}</div>
            ${m.translations && Object.keys(m.translations).length > 0 ? `<div class="li-sub" style="color:var(--green)">âœ“ ÄÃ£ dá»‹ch ${Object.keys(m.translations).filter(k=>!k.endsWith('_desc')).length} ngÃ´n ngá»¯</div>` : '<div class="li-sub" style="color:var(--text3)">ChÆ°a dá»‹ch</div>'}
          </div>
          <div class="li-actions">
            <button class="btn-icon btn-toggle" onclick="toggleMenu('${m.id}')">ğŸ‘</button>
            <button class="btn-icon btn-edit" onclick="openMenuModal('${m.id}')">âœï¸</button>
            <button class="btn-icon btn-delete" onclick="deleteMenu('${m.id}')">ğŸ—‘</button>
          </div>
        </div>`).join('')}
    </div>`).join('');
}

let priceCount = 0;
function addPriceRow(duration='', amount='') {
  priceCount++;
  const id = 'pr' + priceCount;
  const row = document.createElement('div');
  row.className = 'price-row-form'; row.id = id;
  row.innerHTML = `
    <input type="text" placeholder="Thá»i lÆ°á»£ng (vd: 60)" value="${duration}" class="dur-inp">
    <input type="number" placeholder="GiÃ¡ (VNÄ)" value="${amount}" class="amt-inp">
    <button class="del-price" onclick="document.getElementById('${id}').remove()">âœ•</button>`;
  document.getElementById('priceRows').appendChild(row);
}

function openMenuModal(id) {
  priceCount = 0;
  document.getElementById('menuModalTitle').textContent = id ? 'Sá»­a dá»‹ch vá»¥' : 'ThÃªm dá»‹ch vá»¥ má»›i';
  document.getElementById('menuId').value = id || '';
  document.getElementById('translateStatus').className = 'translate-status';
  document.getElementById('priceRows').innerHTML = '';
  const m = id ? db.menus.find(m => m.id === id) : null;
  document.getElementById('menuNameVi').value = m?.nameVi || '';
  document.getElementById('menuDescVi').value = m?.descVi || '';
  document.getElementById('menuCatId').value = m?.catId || '';
  if (m?.prices?.length) { m.prices.forEach(p => addPriceRow(p.duration||p.label||'', p.amount||'')); }
  else { addPriceRow(); }
  document.getElementById('menuModal').classList.add('show');
}
function closeMenuModal() { document.getElementById('menuModal').classList.remove('show'); }

async function saveMenu() {
  const nameVi = document.getElementById('menuNameVi').value.trim();
  const catId = document.getElementById('menuCatId').value;
  if (!nameVi) { alert('Vui lÃ²ng nháº­p tÃªn dá»‹ch vá»¥!'); return; }
  if (!catId) { alert('Vui lÃ²ng chá»n danh má»¥c!'); return; }

  const priceRows = document.querySelectorAll('#priceRows .price-row-form');
  const prices = Array.from(priceRows).map(row => ({
    duration: row.querySelector('.dur-inp')?.value.trim() || '',
    amount: parseInt(row.querySelector('.amt-inp')?.value || '0') || 0
  })).filter(p => p.amount > 0);

  const descVi = document.getElementById('menuDescVi').value.trim();
  const id = document.getElementById('menuId').value;

  // Show translating status
  const statusEl = document.getElementById('translateStatus');
  statusEl.className = 'translate-status loading';
  statusEl.textContent = 'ğŸ”„ Äang dá»‹ch tá»± Ä‘á»™ng sang cÃ¡c ngÃ´n ngá»¯...';

  // Translate
  let translations = {};
  try {
    const [nameTranslations, descTranslations] = await Promise.all([
      DB.translateToAllLangs(nameVi),
      descVi ? DB.translateToAllLangs(descVi) : Promise.resolve({})
    ]);
    translations = { ...nameTranslations };
    Object.entries(descTranslations).forEach(([lang, val]) => {
      translations[lang + '_desc'] = val;
    });
    statusEl.className = 'translate-status done';
    statusEl.textContent = 'âœ… ÄÃ£ dá»‹ch thÃ nh cÃ´ng!';
  } catch(e) {
    statusEl.className = 'translate-status error';
    statusEl.textContent = 'âš ï¸ Lá»—i dá»‹ch - lÆ°u báº±ng tiáº¿ng Viá»‡t.';
  }

  db = DB.loadDB();
  if (id) {
    const idx = db.menus.findIndex(m => m.id === id);
    if (idx !== -1) { db.menus[idx] = { ...db.menus[idx], catId, nameVi, descVi, prices, translations }; }
  } else {
    db.menus.push({ id: DB.genId('m'), catId, nameVi, descVi, prices, translations, active: true });
  }
  DB.saveDB(db);
  setTimeout(() => { closeMenuModal(); renderMenuList(); }, 1000);
}

function toggleMenu(id) {
  db = DB.loadDB();
  const m = db.menus.find(m => m.id === id);
  if (m) { m.active = !m.active; DB.saveDB(db); renderMenuList(); }
}
function deleteMenu(id) {
  if (!confirm('XÃ³a dá»‹ch vá»¥ nÃ y?')) return;
  db = DB.loadDB();
  db.menus = db.menus.filter(m => m.id !== id);
  DB.saveDB(db); renderMenuList();
}

// â”€â”€ CATEGORIES â”€â”€
function renderCatList() {
  const el = document.getElementById('catList');
  el.innerHTML = db.categories.map(c => `
    <div class="list-item">
      <div class="li-info">
        <div class="li-name">${c.icon||''} ${c.nameVi}</div>
        <div class="li-sub">${db.menus.filter(m => m.catId === c.id).length} dá»‹ch vá»¥ | ${Object.keys(c.translations||{}).filter(k=>!k.endsWith('_desc')).length} ngÃ´n ngá»¯</div>
      </div>
      <div class="li-actions">
        <button class="btn-icon btn-edit" onclick="openCatModal('${c.id}')">âœï¸</button>
        <button class="btn-icon btn-delete" onclick="deleteCat('${c.id}')">ğŸ—‘</button>
      </div>
    </div>`).join('');
}

function openCatModal(id) {
  document.getElementById('catModalTitle').textContent = id ? 'Sá»­a danh má»¥c' : 'ThÃªm danh má»¥c';
  document.getElementById('catId').value = id || '';
  const c = id ? db.categories.find(c => c.id === id) : null;
  document.getElementById('catNameVi').value = c?.nameVi || '';
  document.getElementById('catIcon').value = c?.icon || '';
  document.getElementById('catTranslateStatus').className = 'translate-status';
  document.getElementById('catModal').classList.add('show');
}
function closeCatModal() { document.getElementById('catModal').classList.remove('show'); }
async function saveCat() {
  const nameVi = document.getElementById('catNameVi').value.trim();
  if (!nameVi) { alert('Nháº­p tÃªn danh má»¥c!'); return; }
  const icon = document.getElementById('catIcon').value.trim() || 'ğŸ“‹';
  const id = document.getElementById('catId').value;
  const statusEl = document.getElementById('catTranslateStatus');
  statusEl.className = 'translate-status loading'; statusEl.textContent = 'ğŸ”„ Äang dá»‹ch...';
  const translations = await DB.translateToAllLangs(nameVi).catch(() => ({}));
  statusEl.className = 'translate-status done'; statusEl.textContent = 'âœ… ÄÃ£ dá»‹ch!';
  db = DB.loadDB();
  if (id) {
    const idx = db.categories.findIndex(c => c.id === id);
    if (idx !== -1) { db.categories[idx] = { ...db.categories[idx], nameVi, icon, translations }; }
  } else {
    db.categories.push({ id: DB.genId('c'), nameVi, icon, translations });
  }
  DB.saveDB(db);
  setTimeout(() => { closeCatModal(); renderCatList(); renderMenuList(); populateCatSelects(); }, 800);
}
function deleteCat(id) {
  const count = db.menus.filter(m => m.catId === id).length;
  if (!confirm(`XÃ³a danh má»¥c nÃ y? ${count > 0 ? `(${count} dá»‹ch vá»¥ sáº½ bá»‹ máº¥t)` : ''}`)) return;
  db = DB.loadDB();
  db.categories = db.categories.filter(c => c.id !== id);
  db.menus = db.menus.filter(m => m.catId !== id);
  DB.saveDB(db); renderCatList(); renderMenuList(); populateCatSelects();
}

// â”€â”€ NOTE SEARCH â”€â”€
function searchNotes() {
  const q = document.getElementById('noteSearch').value.trim().toLowerCase();
  const el = document.getElementById('noteResults');
  const all = (db.records || []).filter(r => r.note && r.note.trim());
  if (!q) {
    el.innerHTML = all.length === 0 ?
      '<p style="color:var(--text3);font-size:13px;">ChÆ°a cÃ³ ghi chÃº nÃ o.</p>' :
      all.slice(0,20).map(r => noteCard(r, '')).join('');
    return;
  }
  const results = all.filter(r => r.note.toLowerCase().includes(q) || r.menuNameVi.toLowerCase().includes(q) || r.therapistName?.toLowerCase().includes(q));
  el.innerHTML = results.length === 0 ?
    `<p style="color:var(--text3);font-size:13px;">KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£ cho "<b>${q}</b>"</p>` :
    results.map(r => noteCard(r, q)).join('');
}
function noteCard(r, q) {
  const hl = (txt) => !q ? txt : txt.replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), `<span class="highlight">$1</span>`);
  return `<div class="note-result">
    <div class="nr-menu">${hl(r.menuNameVi)}</div>
    <div class="nr-meta">ğŸ‘¤ ${r.therapistName||'â€”'} | ${DB.fmtDateTime(r.completedTime||r.startTime)} | ${DB.fmtMoney(r.amount)}</div>
    <div class="nr-note">ğŸ“ ${hl(r.note)}</div>
  </div>`;
}

// â”€â”€ BACKUP â”€â”€
function doBackup() { DB.backupDB(DB.loadDB()); }
function doRestore(input) {
  const file = input.files[0]; if (!file) return;
  DB.restoreDB(file, (ok, data) => {
    if (ok) { db = data; init(); alert('âœ… KhÃ´i phá»¥c thÃ nh cÃ´ng!'); }
    else { alert('âŒ File khÃ´ng há»£p lá»‡!'); }
  });
}

function exportAll(type) {
  db = DB.loadDB();
  if (type === 'records') {
    DB.exportToCSV('laviespa_records.csv',
      ['Thá»i gian','Dá»‹ch vá»¥','KTV','GiÆ°á»ng','Thá»i lÆ°á»£ng','Doanh thu','Ghi chÃº'],
      (db.records||[]).filter(r=>r.status==='completed').map(r => [
        DB.fmtDateTime(r.completedTime||r.startTime), r.menuNameVi, r.therapistName, r.bedName||'', r.duration?r.duration+' phÃºt':'', r.amount||0, r.note||''
      ]));
  } else if (type === 'menus') {
    DB.exportToCSV('laviespa_menus.csv',
      ['Danh má»¥c','TÃªn dá»‹ch vá»¥','MÃ´ táº£','GiÃ¡'],
      db.menus.map(m => {
        const cat = db.categories.find(c=>c.id===m.catId);
        return [cat?.nameVi||'', m.nameVi, m.descVi||'', m.prices.map(p=>(p.duration?p.duration+'ph ':'')+DB.fmtMoney(p.amount)).join(' | ')];
      }));
  } else if (type === 'therapists') {
    DB.exportToCSV('laviespa_therapists.csv',
      ['TÃªn','Äiá»‡n thoáº¡i','TÃ i khoáº£n ngÃ¢n hÃ ng','Tráº¡ng thÃ¡i'],
      db.therapists.map(t => [t.name, t.phone||'', t.bank||'', t.active!==false?'Hoáº¡t Ä‘á»™ng':'Nghá»‰']));
  }
}

function resetDB() {
  if (!confirm('âš ï¸ XÃ“A TOÃ€N Bá»˜ Dá»® LIá»†U?\nHÃ nh Ä‘á»™ng nÃ y KHÃ”NG THá»‚ hoÃ n tÃ¡c!')) return;
  if (!confirm('Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a táº¥t cáº£?')) return;
  localStorage.removeItem('laviespa_v2');
  location.reload();
}

// Close modals on overlay click
['therapistModal','menuModal','catModal'].forEach(id => {
  document.getElementById(id).addEventListener('click', function(e){ if(e.target===this) this.classList.remove('show'); });
});

init();
</script>
</body>
</html>
