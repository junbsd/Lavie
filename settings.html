<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Lavie Spa - CÃ i Ä‘áº·t</title>
<script src="db.js"></script>
<style>
:root{--bg:#F5F7FA;--card:#fff;--border:#E2E8F0;--brown:#3E2310;--brown2:#5C3A1A;--gold:#96621A;--gold-mid:#B87D2E;--green:#16A34A;--green-l:#DCFCE7;--red:#DC2626;--red-l:#FEE2E2;--blue:#2563EB;--blue-l:#DBEAFE;--yellow:#D97706;--yellow-l:#FEF3C7;--text:#1E293B;--text2:#475569;--text3:#94A3B8;--shadow:rgba(0,0,0,.06);}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans','Segoe UI',sans-serif;min-height:100vh;}
.topbar{background:var(--brown);padding:11px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.3);}
.topbar-logo{font-size:15px;font-weight:700;color:#E8C878;}
.tnav{color:rgba(255,255,255,.65);font-size:11px;padding:5px 10px;border-radius:12px;text-decoration:none;border:1px solid transparent;}
.tnav:hover,.tnav.active{background:rgba(255,255,255,.15);color:#fff;}
.page-tabs{background:#fff;border-bottom:2px solid var(--border);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 4px;}
.page-tabs::-webkit-scrollbar{display:none;}
.ptab{flex-shrink:0;padding:11px 16px;font-size:12.5px;font-weight:600;color:var(--text2);cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;}
.ptab.active{color:var(--gold);border-bottom-color:var(--gold);}
.page-content{padding:14px;max-width:600px;margin:0 auto;display:none;}
.page-content.active{display:block;}
.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 6px var(--shadow);border:1px solid var(--border);}
.card-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);gap:8px;}
.list-item:last-child{border-bottom:none;padding-bottom:0;}
.li-info{flex:1;min-width:0;}
.li-name{font-size:13.5px;font-weight:700;color:var(--text);}
.li-sub{font-size:11px;color:var(--text3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.li-actions{display:flex;gap:6px;flex-shrink:0;}
.ic-btn{width:32px;height:32px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;}
.ic-edit{background:var(--blue-l);color:var(--blue);}
.ic-del{background:var(--red-l);color:var(--red);}
.ic-tog{background:var(--yellow-l);color:var(--yellow);}
.tag{display:inline-block;padding:2px 7px;border-radius:6px;font-size:10px;font-weight:700;margin-left:6px;vertical-align:middle;}
.tag-on{background:var(--green-l);color:var(--green);}
.tag-off{background:var(--border);color:var(--text3);}
.tag-tr{background:var(--blue-l);color:var(--blue);}
.btn-add{width:100%;padding:11px;border-radius:9px;background:var(--gold);color:#fff;font-size:13px;font-weight:700;border:none;cursor:pointer;margin-top:10px;}
.btn-add:hover{background:var(--brown2);}
.field-lbl{font-size:12px;font-weight:700;color:var(--text2);margin:11px 0 4px;}
.field-input,.field-sel,.field-ta{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13.5px;font-family:inherit;color:var(--text);background:#fff;}
.field-ta{resize:vertical;min-height:65px;line-height:1.5;}
.field-input:focus,.field-sel:focus,.field-ta:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(150,98,26,.1);}
.price-rows{border:1.5px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:4px;}
.prow{display:flex;align-items:center;border-bottom:1px solid var(--border);}
.prow:last-child{border-bottom:none;}
.prow input{flex:1;padding:9px 10px;border:none;font-size:13px;font-family:inherit;background:transparent;color:var(--text);}
.prow input:focus{outline:none;background:var(--blue-l);}
.prow .div{width:1px;background:var(--border);height:38px;flex-shrink:0;}
.prow .del{width:36px;height:38px;background:transparent;border:none;color:var(--red);cursor:pointer;font-size:16px;flex-shrink:0;}
.prow .del:hover{background:var(--red-l);}
.btn-add-price{padding:7px 12px;border-radius:7px;background:var(--blue-l);color:var(--blue);border:1px solid var(--blue);font-size:12px;cursor:pointer;font-weight:600;}
.trans-st{font-size:12px;padding:8px 11px;border-radius:7px;margin-top:8px;display:none;line-height:1.4;}
.trans-st.loading{background:var(--yellow-l);color:var(--yellow);display:block;}
.trans-st.done{background:var(--green-l);color:var(--green);display:block;}
.trans-st.error{background:var(--red-l);color:var(--red);display:block;}
/* Loading */
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;}
.spin{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--gold-mid);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:500;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:#fff;border-radius:22px 22px 0 0;padding:20px 18px 34px;width:100%;max-width:540px;max-height:93vh;overflow-y:auto;animation:slideUp .28s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-drag{width:40px;height:4px;background:#ddd;border-radius:4px;margin:0 auto 14px;}
.modal-title{font-size:17px;font-weight:700;color:var(--text);margin-bottom:14px;}
.modal-btn-row{display:flex;gap:8px;margin-top:16px;}
.btn-prim{flex:1;padding:12px;border-radius:9px;background:var(--gold);color:#fff;font-size:14px;font-weight:700;border:none;cursor:pointer;}
.btn-prim:disabled{background:#ccc;cursor:not-allowed;}
.btn-sec{flex:1;padding:12px;border-radius:9px;background:var(--bg);color:var(--text2);font-size:14px;font-weight:600;border:1.5px solid var(--border);cursor:pointer;}
/* Backup */
.chip-row{display:flex;gap:8px;flex-wrap:wrap;}
.chip{display:inline-flex;align-items:center;gap:5px;padding:9px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;}
.chip-gold{background:var(--gold);color:#fff;}
.chip-green{background:var(--green-l);color:var(--green);border:1.5px solid var(--green);}
.chip-blue{background:var(--blue-l);color:var(--blue);border:1.5px solid var(--blue);}
.chip-red{background:var(--red-l);color:var(--red);border:1.5px solid var(--red);}
/* Note search */
.search-in{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:inherit;color:var(--text);margin-bottom:12px;}
.search-in:focus{outline:none;border-color:var(--gold);}
.nc{background:var(--card);border-radius:9px;padding:10px 12px;margin-bottom:7px;border:1px solid var(--border);}
.nc-menu{font-size:13px;font-weight:700;color:var(--text);}
.nc-meta{font-size:11px;color:var(--text3);margin-top:2px;}
.nc-body{font-size:12px;color:var(--blue);margin-top:5px;padding:5px 8px;background:var(--blue-l);border-radius:6px;}
mark{background:#FFF176;padding:1px 2px;border-radius:2px;}
.dz{border:1.5px solid var(--red);border-radius:10px;padding:14px;}
.dz-title{font-size:13px;font-weight:700;color:var(--red);margin-bottom:6px;}
</style>
</head>
<body>
<div class="loading-screen" id="loadingScreen">
  <img id="settingsLoadLogo" src="" style="height:50px;object-fit:contain;margin-bottom:8px" alt="Lavie Spa"><br>
  <div class="spin"></div>
  <div style="margin-top:12px;color:var(--text3);font-size:13px">Äang táº£i cÃ i Ä‘áº·t...</div>
</div>
<div id="appBody" style="display:none">
<div class="topbar">
  <div class="topbar-logo"><img id="topLogo" src="" style="height:28px;object-fit:contain;vertical-align:middle;margin-right:6px" alt="">CÃ i Ä‘áº·t</div>
  <div style="display:flex;gap:4px">
    <a class="tnav" href="index.html">ğŸ“‹ Menu</a>
    <a class="tnav" href="admin.html">âš™ï¸ Quáº£n lÃ½</a>
    <a class="tnav active" href="settings.html">ğŸ›  CÃ i Ä‘áº·t</a>
  </div>
</div>
<div class="page-tabs">
  <div class="ptab active" onclick="showPage('thr')">ğŸ‘¤ Ká»¹ thuáº­t viÃªn</div>
  <div class="ptab" onclick="showPage('menus')">ğŸ“‹ Menu dá»‹ch vá»¥</div>
  <div class="ptab" onclick="showPage('cats')">ğŸ—‚ Danh má»¥c</div>
  <div class="ptab" onclick="showPage('beds')">ğŸ› GiÆ°á»ng</div>
  <div class="ptab" onclick="showPage('notes')">ğŸ” Ghi chÃº</div>
  <div class="ptab" onclick="showPage('backup')">ğŸ’¾ Sao lÆ°u</div>
</div>

<!-- Therapists -->
<div id="page-thr" class="page-content active">
  <div class="card">
    <div class="card-title">Ká»¹ thuáº­t viÃªn <button class="ic-btn ic-edit" style="width:auto;padding:0 12px;font-size:12px;font-weight:700" onclick="openThrModal(null)">+ ThÃªm</button></div>
    <div id="thrList"></div>
    <button class="btn-add" onclick="openThrModal(null)">+ ThÃªm ká»¹ thuáº­t viÃªn má»›i</button>
  </div>
</div>

<!-- Menus -->
<div id="page-menus" class="page-content">
  <div class="card" style="padding:12px 14px">
    <div class="field-lbl" style="margin-top:0">Lá»c theo danh má»¥c</div>
    <select class="field-sel" id="menuCatFilter" onchange="renderMenuList()">
      <option value="">-- Táº¥t cáº£ --</option>
    </select>
  </div>
  <div id="menuList"></div>
  <button class="btn-add" onclick="openMenuModal(null)">+ ThÃªm dá»‹ch vá»¥ má»›i</button>
</div>

<!-- Categories -->
<div id="page-cats" class="page-content">
  <div class="card">
    <div class="card-title">Danh má»¥c <button class="ic-btn ic-edit" style="width:auto;padding:0 12px;font-size:12px;font-weight:700" onclick="openCatModal(null)">+ ThÃªm</button></div>
    <div id="catList"></div>
    <button class="btn-add" onclick="openCatModal(null)">+ ThÃªm danh má»¥c má»›i</button>
  </div>
</div>

<!-- Beds -->
<div id="page-beds" class="page-content">
  <div class="card">
    <div class="card-title">GiÆ°á»ng / PhÃ²ng <button class="ic-btn ic-edit" style="width:auto;padding:0 12px;font-size:12px;font-weight:700" onclick="openBedModal(null)">+ ThÃªm</button></div>
    <div id="bedList"></div>
    <button class="btn-add" onclick="openBedModal(null)">+ ThÃªm giÆ°á»ng / phÃ²ng má»›i</button>
  </div>
</div>

<!-- Notes search -->
<div id="page-notes" class="page-content">
  <div class="card">
    <div class="card-title">ğŸ” TÃ¬m kiáº¿m ghi chÃº</div>
    <input class="search-in" id="noteSearchIn" type="text" placeholder="Nháº­p tá»« khoÃ¡: tÃªn dá»‹ch vá»¥, ká»¹ thuáº­t viÃªn, ghi chÃº..." oninput="renderNoteSearch()">
    <div id="noteResults"></div>
  </div>
</div>

<!-- Backup -->
<div id="page-backup" class="page-content">
  <div class="card">
    <div class="card-title">ğŸ’¾ Sao lÆ°u & KhÃ´i phá»¥c</div>
    <p style="font-size:12.5px;color:var(--text2);margin-bottom:14px;line-height:1.6">Sao lÆ°u toÃ n bá»™ dá»¯ liá»‡u tá»« Firestore thÃ nh file JSON. CÃ³ thá»ƒ khÃ´i phá»¥c báº¥t ká»³ lÃºc nÃ o.</p>
    <div class="chip-row">
      <button class="chip chip-gold" onclick="doBackup()">ğŸ“¦ Táº£i vá» (JSON)</button>
      <label class="chip chip-green" style="cursor:pointer">ğŸ“‚ KhÃ´i phá»¥c<input type="file" accept=".json" style="display:none" onchange="doRestore(this)"></label>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“¥ Xuáº¥t Excel (CSV)</div>
    <div class="chip-row">
      <button class="chip chip-blue" onclick="exportData('records')">ğŸ“‹ Lá»‹ch sá»­</button>
      <button class="chip chip-blue" onclick="exportData('menus')">ğŸ—’ Dá»‹ch vá»¥</button>
      <button class="chip chip-blue" onclick="exportData('therapists')">ğŸ‘¥ Ká»¹ thuáº­t viÃªn</button>
    </div>
  </div>
  <div class="card">
    <div class="dz">
      <div class="dz-title">âš ï¸ VÃ¹ng nguy hiá»ƒm</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:10px">XÃ³a toÃ n bá»™ dá»¯ liá»‡u trÃªn Firestore. KhÃ´ng thá»ƒ hoÃ n tÃ¡c!</div>
      <button class="chip chip-red" onclick="resetAll()">ğŸ—‘ XÃ³a toÃ n bá»™ dá»¯ liá»‡u</button>
    </div>
  </div>
</div>
</div><!-- /appBody -->

<!-- Therapist Modal -->
<div class="modal-overlay" id="thrModal" onclick="if(event.target===this)closeThrModal()">
  <div class="modal-sheet">
    <div class="modal-drag"></div>
    <div class="modal-title" id="thrModalTitle">ThÃªm ká»¹ thuáº­t viÃªn</div>
    <div class="field-lbl">TÃªn <span style="color:var(--red)">*</span></div>
    <input class="field-input" id="thrName" type="text" placeholder="Nháº­p tÃªn...">
    <div class="field-lbl">Sá»‘ Ä‘iá»‡n thoáº¡i</div>
    <input class="field-input" id="thrPhone" type="tel" placeholder="0901 234 567">
    <div class="field-lbl">TÃ i khoáº£n ngÃ¢n hÃ ng</div>
    <input class="field-input" id="thrBank" type="text" placeholder="VD: MB Bank - 012345678">
    <div class="modal-btn-row">
      <button class="btn-sec" onclick="closeThrModal()">Há»§y</button>
      <button class="btn-prim" onclick="saveThr()">ğŸ’¾ LÆ°u</button>
    </div>
  </div>
</div>

<!-- Menu Modal -->
<div class="modal-overlay" id="menuModal" onclick="if(event.target===this)closeMenuModal()">
  <div class="modal-sheet">
    <div class="modal-drag"></div>
    <div class="modal-title" id="menuModalTitle">ThÃªm dá»‹ch vá»¥</div>
    <div class="field-lbl">Danh má»¥c <span style="color:var(--red)">*</span></div>
    <select class="field-sel" id="menuCatId"></select>
    <div class="field-lbl">TÃªn dá»‹ch vá»¥ (Tiáº¿ng Viá»‡t) <span style="color:var(--red)">*</span></div>
    <input class="field-input" id="menuNameVi" type="text" placeholder="VD: Massage cá»• vai gÃ¡y trá»‹ liá»‡u">
    <div class="field-lbl">MÃ´ táº£ (Tiáº¿ng Viá»‡t)</div>
    <textarea class="field-ta" id="menuDescVi" placeholder="VD: NgÃ¢m chÃ¢n tháº£o dÆ°á»£c + massage..."></textarea>
    <div class="field-lbl">Má»©c giÃ¡</div>
    <div class="price-rows" id="priceRowsWrap"></div>
    <button class="btn-add-price" style="margin-top:6px" onclick="addPriceRow('','')">+ ThÃªm má»©c giÃ¡</button>
    <div class="trans-st" id="menuTransSt"></div>
    <div class="modal-btn-row">
      <button class="btn-sec" onclick="closeMenuModal()">Há»§y</button>
      <button class="btn-prim" id="menuSaveBtn" onclick="saveMenu()">ğŸ’¾ LÆ°u & Tá»± Ä‘á»™ng dá»‹ch</button>
    </div>
  </div>
</div>

<!-- Category Modal -->
<div class="modal-overlay" id="catModal" onclick="if(event.target===this)closeCatModal()">
  <div class="modal-sheet">
    <div class="modal-drag"></div>
    <div class="modal-title" id="catModalTitle">ThÃªm danh má»¥c</div>
    <div class="field-lbl">TÃªn (Tiáº¿ng Viá»‡t) <span style="color:var(--red)">*</span></div>
    <input class="field-input" id="catNameVi" type="text" placeholder="VD: Massage Trá»‹ Liá»‡u">
    <div class="field-lbl">Icon (emoji)</div>
    <input class="field-input" id="catIcon" type="text" placeholder="ğŸ’†" maxlength="4" style="font-size:24px;text-align:center">
    <div class="trans-st" id="catTransSt"></div>
    <div class="modal-btn-row">
      <button class="btn-sec" onclick="closeCatModal()">Há»§y</button>
      <button class="btn-prim" onclick="saveCat()">ğŸ’¾ LÆ°u</button>
    </div>
  </div>
</div>

<!-- Bed Modal -->
<div class="modal-overlay" id="bedModal" onclick="if(event.target===this)closeBedModal()">
  <div class="modal-sheet">
    <div class="modal-drag"></div>
    <div class="modal-title" id="bedModalTitle">ThÃªm giÆ°á»ng / phÃ²ng</div>
    <div class="field-lbl">TÃªn <span style="color:var(--red)">*</span></div>
    <input class="field-input" id="bedName" type="text" placeholder="VD: GiÆ°á»ng 1, PhÃ²ng VIP, PhÃ²ng Sauna...">
    <div class="modal-btn-row">
      <button class="btn-sec" onclick="closeBedModal()">Há»§y</button>
      <button class="btn-prim" onclick="saveBed()">ğŸ’¾ LÆ°u</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }         from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
         collection, getDocs, query, orderBy, writeBatch }
  from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const app = initializeApp(DB.FIREBASE_CONFIG);
const fs  = getFirestore(app);

// Set logo images
(function(){
  const src = DB.LAVIE_LOGO_B64;
  if(!src) return;
  document.querySelectorAll('[id$="Logo"],[id$="logo"],[id$="Logo"],[id="topLogo"]').forEach(el=>{if(el.tagName==='IMG') el.src=src;});
  // try specific ids
  ['adminLoadLogo','settingsLoadLogo','topLogo'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.src=src;
  });
})();

let appData = { categories:[], menus:[], beds:[], therapists:[], records:[] };
let editThrId=null, editMenuId=null, editCatId=null, editBedId=null;
let priceRowCnt=0;

// â”€â”€ Helpers â”€â”€
function esc(s){ return DB.escHtml(s); }
async function saveConfig(){
  await setDoc(doc(fs,'config','main'),{
    categories: appData.categories,
    menus:      appData.menus,
    beds:       appData.beds
  });
}

// â”€â”€ Load â”€â”€
async function loadAll(){
  const [configSnap, thrSnap, recSnap] = await Promise.all([
    getDoc(doc(fs,'config','main')),
    getDocs(collection(fs,'therapists')),
    getDocs(collection(fs,'records'))
  ]);

  // Re-seed if no data or no translations
  let needReseed = !configSnap.exists();
  if (!needReseed) {
    const cfg0 = configSnap.data();
    const m0 = (cfg0.menus||[])[0];
    if (!m0 || !m0.translations || Object.keys(m0.translations).length === 0) needReseed = true;
  }
  if (needReseed) {
    await setDoc(doc(fs,'config','main'),{
      categories: DB.DEFAULT_DATA.categories,
      menus:      DB.DEFAULT_DATA.menus,
      beds:       DB.DEFAULT_DATA.beds
    });
    appData.categories = DB.DEFAULT_DATA.categories;
    appData.menus      = DB.DEFAULT_DATA.menus;
    appData.beds       = DB.DEFAULT_DATA.beds;
  } else if(configSnap.exists()){
    const cfg=configSnap.data();
    appData.categories=cfg.categories||[];
    appData.menus=cfg.menus||[];
    appData.beds=cfg.beds||[];
  }
  appData.therapists=thrSnap.docs.map(d=>d.data());
  appData.records=recSnap.docs.map(d=>d.data());

  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('appBody').style.display='block';
  populateCatDropdowns();
  renderTherapists();
  renderMenuList();
  renderCatList();
  renderBedList();
}

// â”€â”€ Page â”€â”€
window.showPage=function(name){
  const pages=['thr','menus','cats','beds','notes','backup'];
  pages.forEach(p=>document.getElementById('page-'+p).classList.toggle('active',p===name));
  document.querySelectorAll('.ptab').forEach((t,i)=>t.classList.toggle('active',pages[i]===name));
  if(name==='notes') renderNoteSearch();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ THERAPISTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTherapists(){
  const el=document.getElementById('thrList');
  if(!appData.therapists.length){el.innerHTML='<p style="color:var(--text3);font-size:13px;padding:8px 0">ChÆ°a cÃ³ ká»¹ thuáº­t viÃªn.</p>';return;}
  el.innerHTML=appData.therapists.map(t=>{
    const isActive=t.active!==false;
    const sub=[t.phone,t.bank].filter(Boolean).join(' | ');
    return `<div class="list-item">
      <div class="li-info">
        <div class="li-name">${esc(t.name)}<span class="tag ${isActive?'tag-on':'tag-off'}">${isActive?'Hoáº¡t Ä‘á»™ng':'Nghá»‰'}</span></div>
        <div class="li-sub">${esc(sub||'ChÆ°a cÃ³ thÃ´ng tin')}</div>
      </div>
      <div class="li-actions">
        <button class="ic-btn ic-tog" onclick="toggleThr('${t.id}')" title="Báº­t/Táº¯t">â¸</button>
        <button class="ic-btn ic-edit" onclick="openThrModal('${t.id}')">âœï¸</button>
        <button class="ic-btn ic-del"  onclick="deleteThr('${t.id}')">ğŸ—‘</button>
      </div></div>`;
  }).join('');
}

window.openThrModal=function(id){
  editThrId=id;
  const t=id?appData.therapists.find(x=>x.id===id):null;
  document.getElementById('thrModalTitle').textContent=id?'Sá»­a ká»¹ thuáº­t viÃªn':'ThÃªm ká»¹ thuáº­t viÃªn má»›i';
  document.getElementById('thrName').value=t?t.name||'':'';
  document.getElementById('thrPhone').value=t?t.phone||'':'';
  document.getElementById('thrBank').value=t?t.bank||'':'';
  document.getElementById('thrModal').classList.add('show');
  setTimeout(()=>document.getElementById('thrName').focus(),150);
};
window.closeThrModal=function(){document.getElementById('thrModal').classList.remove('show');editThrId=null;};
window.saveThr=async function(){
  const name=document.getElementById('thrName').value.trim();
  if(!name){alert('Vui lÃ²ng nháº­p tÃªn!');return;}
  const phone=document.getElementById('thrPhone').value.trim();
  const bank=document.getElementById('thrBank').value.trim();
  if(editThrId){
    // update
    await updateDoc(doc(fs,'therapists',editThrId),{name,phone,bank});
    const idx=appData.therapists.findIndex(t=>t.id===editThrId);
    if(idx!==-1){appData.therapists[idx]={...appData.therapists[idx],name,phone,bank};}
  } else {
    // add
    const newT={id:DB.genId('t'),name,phone,bank,active:true};
    await setDoc(doc(fs,'therapists',newT.id),newT);
    appData.therapists.push(newT);
  }
  closeThrModal();
  renderTherapists();
};
window.toggleThr=async function(id){
  const t=appData.therapists.find(x=>x.id===id);
  if(!t) return;
  const newActive=t.active===false?true:false;
  await updateDoc(doc(fs,'therapists',id),{active:newActive});
  t.active=newActive;
  renderTherapists();
};
window.deleteThr=async function(id){
  if(!confirm('XÃ³a ká»¹ thuáº­t viÃªn nÃ y?')) return;
  await deleteDoc(doc(fs,'therapists',id));
  appData.therapists=appData.therapists.filter(t=>t.id!==id);
  renderTherapists();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MENUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateCatDropdowns(){
  const opts=appData.categories.map(c=>`<option value="${c.id}">${esc(c.icon||'')} ${esc(c.nameVi)}</option>`).join('');
  const fEl=document.getElementById('menuCatFilter');
  const mEl=document.getElementById('menuCatId');
  if(fEl) fEl.innerHTML='<option value="">-- Táº¥t cáº£ --</option>'+opts;
  if(mEl) mEl.innerHTML='<option value="">-- Chá»n danh má»¥c --</option>'+opts;
}

function renderMenuList(){
  const fv=(document.getElementById('menuCatFilter')||{}).value||'';
  const menus=fv?appData.menus.filter(m=>m.catId===fv):appData.menus;
  const groups={},order=[];
  menus.forEach(m=>{
    if(!groups[m.catId]){groups[m.catId]={cat:appData.categories.find(c=>c.id===m.catId),items:[]};order.push(m.catId);}
    groups[m.catId].items.push(m);
  });
  const el=document.getElementById('menuList');
  if(!order.length){el.innerHTML='<div class="card" style="text-align:center;color:var(--text3);padding:20px">ChÆ°a cÃ³ dá»‹ch vá»¥.</div>';return;}
  el.innerHTML=order.map(key=>{
    const g=groups[key];
    const catName=g.cat?`${g.cat.icon||''} ${g.cat.nameVi}`:'Danh má»¥c khÃ¡c';
    const itemsHtml=g.items.map(m=>{
      const ps=m.prices.map(p=>(p.duration?p.duration+'ph ':p.label?p.label+' ':'')+DB.fmtMoney(p.amount)).join(' | ');
      const tc=Object.keys(m.translations||{}).filter(k=>!k.endsWith('_desc')).length;
      return `<div class="list-item">
        <div class="li-info">
          <div class="li-name">${esc(m.nameVi)}<span class="tag ${m.active?'tag-on':'tag-off'}">${m.active?'Hiá»‡n':'áº¨n'}</span>${tc>0?`<span class="tag tag-tr">âœ“ ${tc} ngÃ´n ngá»¯</span>`:''}</div>
          <div class="li-sub">${esc(ps)}</div>
        </div>
        <div class="li-actions">
          <button class="ic-btn ic-tog" onclick="toggleMenu('${m.id}')">ğŸ‘</button>
          <button class="ic-btn ic-edit" onclick="openMenuModal('${m.id}')">âœï¸</button>
          <button class="ic-btn ic-del" onclick="deleteMenu('${m.id}')">ğŸ—‘</button>
        </div></div>`;
    }).join('');
    return `<div class="card"><div class="card-title">${esc(catName)}</div>${itemsHtml}</div>`;
  }).join('');
}

function addPriceRow(dur,amt){
  priceRowCnt++;
  const id='prow_'+priceRowCnt;
  const wrap=document.getElementById('priceRowsWrap');
  const div=document.createElement('div');
  div.className='prow'; div.id=id;
  div.innerHTML=`<input type="text" class="dur" placeholder="Thá»i lÆ°á»£ng (vd: 60)" value="${esc(dur||'')}"><div class="div"></div><input type="number" class="amt" placeholder="GiÃ¡ (VNÄ)" value="${amt||''}"><button type="button" class="del" onclick="document.getElementById('${id}').remove()">âœ•</button>`;
  wrap.appendChild(div);
}
window.addPriceRow=addPriceRow;

window.openMenuModal=function(id){
  priceRowCnt=0; editMenuId=id;
  const m=id?appData.menus.find(x=>x.id===id):null;
  document.getElementById('menuModalTitle').textContent=id?'Sá»­a dá»‹ch vá»¥':'ThÃªm dá»‹ch vá»¥ má»›i';
  document.getElementById('menuNameVi').value=m?m.nameVi||'':'';
  document.getElementById('menuDescVi').value=m?m.descVi||'':'';
  document.getElementById('menuCatId').value=m?m.catId||'':'';
  document.getElementById('menuTransSt').className='trans-st';
  document.getElementById('menuSaveBtn').disabled=false;
  document.getElementById('priceRowsWrap').innerHTML='';
  if(m&&m.prices&&m.prices.length){m.prices.forEach(p=>addPriceRow(p.duration||p.label||'',p.amount||''));}
  else addPriceRow('','');
  document.getElementById('menuModal').classList.add('show');
  setTimeout(()=>document.getElementById('menuNameVi').focus(),150);
};
window.closeMenuModal=function(){document.getElementById('menuModal').classList.remove('show');editMenuId=null;};

window.saveMenu=async function(){
  const nameVi=document.getElementById('menuNameVi').value.trim();
  const catId=document.getElementById('menuCatId').value;
  const descVi=document.getElementById('menuDescVi').value.trim();
  if(!nameVi){alert('Vui lÃ²ng nháº­p tÃªn dá»‹ch vá»¥!');return;}
  if(!catId){alert('Vui lÃ²ng chá»n danh má»¥c!');return;}
  const pRows=document.querySelectorAll('#priceRowsWrap .prow');
  const prices=Array.from(pRows).map(row=>({
    duration:(row.querySelector('.dur').value||'').trim(),
    amount:parseInt(row.querySelector('.amt').value||'0',10)||0
  })).filter(p=>p.amount>0);
  if(!prices.length){alert('Nháº­p Ã­t nháº¥t 1 má»©c giÃ¡!');return;}

  const stEl=document.getElementById('menuTransSt');
  const saveBtn=document.getElementById('menuSaveBtn');

  // Check if we already have translations (editing)
  const existing=editMenuId?appData.menus.find(m=>m.id===editMenuId):null;
  const existingNameVi=existing?existing.nameVi:'';
  const needTranslate=!existing||(existing.nameVi!==nameVi)||(Object.keys(existing.translations||{}).filter(k=>!k.endsWith('_desc')).length===0);

  let translations=existing?{...existing.translations}:{};

  if(needTranslate){
    stEl.className='trans-st loading';
    stEl.textContent='ğŸ”„ Äang dá»‹ch tá»± Ä‘á»™ng (Google Translate)... Vui lÃ²ng chá»';
    saveBtn.disabled=true;
    try{
      const [nt,dt]=await Promise.all([
        translateText(nameVi),
        descVi?translateText(descVi):Promise.resolve({})
      ]);
      translations={...nt};
      Object.entries(dt).forEach(([l,v])=>{translations[l+'_desc']=v;});
      const cnt=Object.keys(nt).filter(k=>nt[k]&&nt[k]!==nameVi).length;
      stEl.className='trans-st done';
      stEl.textContent='âœ… ÄÃ£ dá»‹ch thÃ nh cÃ´ng '+cnt+'/7 ngÃ´n ngá»¯ â€” lÆ°u vÃ o Firestore!';
    }catch(e){
      stEl.className='trans-st error';
      stEl.textContent='âš ï¸ Lá»—i dá»‹ch - lÆ°u báº±ng tiáº¿ng Viá»‡t. VÃ o trang menu, Ä‘á»•i ngÃ´n ngá»¯ Ä‘á»ƒ kiá»ƒm tra.';
      translations={};
    }
  } else {
    stEl.className='trans-st done';
    stEl.textContent='âœ… ÄÃ£ cÃ³ báº£n dá»‹ch trong DB â€” dÃ¹ng láº¡i, khÃ´ng cáº§n dá»‹ch láº¡i.';
  }

  if(editMenuId){
    const idx=appData.menus.findIndex(m=>m.id===editMenuId);
    if(idx!==-1){appData.menus[idx]={...appData.menus[idx],catId,nameVi,descVi,prices,translations};}
  } else {
    appData.menus.push({id:DB.genId('m'),catId,nameVi,descVi,prices,translations,active:true});
  }
  await saveConfig();
  setTimeout(()=>{closeMenuModal();renderMenuList();saveBtn.disabled=false;},1000);
};

window.toggleMenu=async function(id){
  const m=appData.menus.find(x=>x.id===id);
  if(!m) return;
  m.active=!m.active;
  await saveConfig();
  renderMenuList();
};
window.deleteMenu=async function(id){
  if(!confirm('XÃ³a dá»‹ch vá»¥ nÃ y?')) return;
  appData.menus=appData.menus.filter(m=>m.id!==id);
  await saveConfig();
  renderMenuList();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CATEGORIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCatList(){
  const el=document.getElementById('catList');
  if(!appData.categories.length){el.innerHTML='<p style="color:var(--text3);font-size:13px;padding:8px 0">ChÆ°a cÃ³ danh má»¥c.</p>';return;}
  el.innerHTML=appData.categories.map(c=>{
    const cnt=appData.menus.filter(m=>m.catId===c.id).length;
    const tc=Object.keys(c.translations||{}).length;
    return `<div class="list-item">
      <div class="li-info">
        <div class="li-name">${esc((c.icon||'')+' '+c.nameVi)}${tc>0?'<span class="tag tag-tr">âœ“ ÄÃ£ dá»‹ch</span>':''}</div>
        <div class="li-sub">${cnt} dá»‹ch vá»¥</div>
      </div>
      <div class="li-actions">
        <button class="ic-btn ic-edit" onclick="openCatModal('${c.id}')">âœï¸</button>
        <button class="ic-btn ic-del"  onclick="deleteCat('${c.id}')">ğŸ—‘</button>
      </div></div>`;
  }).join('');
}

window.openCatModal=function(id){
  editCatId=id;
  const c=id?appData.categories.find(x=>x.id===id):null;
  document.getElementById('catModalTitle').textContent=id?'Sá»­a danh má»¥c':'ThÃªm danh má»¥c má»›i';
  document.getElementById('catNameVi').value=c?c.nameVi||'':'';
  document.getElementById('catIcon').value=c?c.icon||'':'';
  document.getElementById('catTransSt').className='trans-st';
  document.getElementById('catModal').classList.add('show');
  setTimeout(()=>document.getElementById('catNameVi').focus(),150);
};
window.closeCatModal=function(){document.getElementById('catModal').classList.remove('show');editCatId=null;};
window.saveCat=async function(){
  const nameVi=document.getElementById('catNameVi').value.trim();
  if(!nameVi){alert('Nháº­p tÃªn danh má»¥c!');return;}
  const icon=document.getElementById('catIcon').value.trim()||'ğŸ“‹';
  const stEl=document.getElementById('catTransSt');
  stEl.className='trans-st loading'; stEl.textContent='ğŸ”„ Äang dá»‹ch...';
  let translations={};
  try{translations=await translateText(nameVi);stEl.className='trans-st done';stEl.textContent='âœ… ÄÃ£ dá»‹ch vÃ  lÆ°u vÃ o DB!';}
  catch(e){stEl.className='trans-st error';stEl.textContent='âš ï¸ Lá»—i dá»‹ch.';}
  if(editCatId){
    const idx=appData.categories.findIndex(c=>c.id===editCatId);
    if(idx!==-1){appData.categories[idx]={...appData.categories[idx],nameVi,icon,translations};}
  } else {
    appData.categories.push({id:DB.genId('c'),nameVi,icon,translations});
  }
  await saveConfig();
  setTimeout(()=>{closeCatModal();renderCatList();populateCatDropdowns();renderMenuList();},900);
};
window.deleteCat=async function(id){
  const cnt=appData.menus.filter(m=>m.catId===id).length;
  if(!confirm('XÃ³a danh má»¥c nÃ y?'+(cnt>0?'\nâš ï¸ '+cnt+' dá»‹ch vá»¥ cÅ©ng sáº½ bá»‹ xÃ³a!':''))) return;
  appData.categories=appData.categories.filter(c=>c.id!==id);
  if(cnt>0) appData.menus=appData.menus.filter(m=>m.catId!==id);
  await saveConfig();
  renderCatList(); populateCatDropdowns(); renderMenuList();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BEDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBedList(){
  const el=document.getElementById('bedList');
  if(!appData.beds.length){el.innerHTML='<p style="color:var(--text3);font-size:13px;padding:8px 0">ChÆ°a cÃ³ giÆ°á»ng/phÃ²ng nÃ o.</p>';return;}
  el.innerHTML=appData.beds.map(b=>`
    <div class="list-item">
      <div class="li-info"><div class="li-name">ğŸ› ${esc(b.name)}</div></div>
      <div class="li-actions">
        <button class="ic-btn ic-edit" onclick="openBedModal('${b.id}')">âœï¸</button>
        <button class="ic-btn ic-del"  onclick="deleteBed('${b.id}')">ğŸ—‘</button>
      </div></div>`).join('');
}

window.openBedModal=function(id){
  editBedId=id;
  const b=id?appData.beds.find(x=>x.id===id):null;
  document.getElementById('bedModalTitle').textContent=id?'Sá»­a giÆ°á»ng/phÃ²ng':'ThÃªm giÆ°á»ng/phÃ²ng má»›i';
  document.getElementById('bedName').value=b?b.name||'':'';
  document.getElementById('bedModal').classList.add('show');
  setTimeout(()=>document.getElementById('bedName').focus(),150);
};
window.closeBedModal=function(){document.getElementById('bedModal').classList.remove('show');editBedId=null;};
window.saveBed=async function(){
  const name=document.getElementById('bedName').value.trim();
  if(!name){alert('Nháº­p tÃªn giÆ°á»ng/phÃ²ng!');return;}
  if(editBedId){
    const idx=appData.beds.findIndex(b=>b.id===editBedId);
    if(idx!==-1){appData.beds[idx]={...appData.beds[idx],name};}
  } else {
    appData.beds.push({id:DB.genId('b'),name});
  }
  await saveConfig();
  closeBedModal(); renderBedList();
};
window.deleteBed=async function(id){
  if(!confirm('XÃ³a giÆ°á»ng/phÃ²ng nÃ y?')) return;
  appData.beds=appData.beds.filter(b=>b.id!==id);
  await saveConfig(); renderBedList();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NOTE SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.renderNoteSearch=function(){
  const q=(document.getElementById('noteSearchIn').value||'').trim().toLowerCase();
  const all=(appData.records||[]).filter(r=>r.note&&r.note.trim()&&r.status==='completed');
  const el=document.getElementById('noteResults');
  function hl(txt){
    if(!q||!txt) return esc(txt||'');
    return esc(txt).replace(new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<mark>$1</mark>');
  }
  function nc(r){
    return `<div class="nc"><div class="nc-menu">${hl(r.menuNameVi)}</div><div class="nc-meta">ğŸ‘¤ ${hl(r.therapistName||'â€”')} | ${DB.fmtDateTime(r.completedTime||r.startTime)} | ${DB.fmtMoney(r.amount)}</div><div class="nc-body">ğŸ“ ${hl(r.note)}</div></div>`;
  }
  const results=q?all.filter(r=>(r.note||'').toLowerCase().includes(q)||(r.menuNameVi||'').toLowerCase().includes(q)||(r.therapistName||'').toLowerCase().includes(q)):all.slice(0,30);
  if(!results.length){el.innerHTML=`<p style="color:var(--text3);font-size:13px;text-align:center;padding:20px">${q?'KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£.':'ChÆ°a cÃ³ ghi chÃº nÃ o.'}</p>`;return;}
  el.innerHTML=(q?`<p style="color:var(--text3);font-size:12px;margin-bottom:8px">TÃ¬m tháº¥y ${results.length} káº¿t quáº£</p>`:'')+
    results.sort((a,b)=>(b.completedTime||b.startTime)-(a.completedTime||a.startTime)).map(nc).join('');
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TRANSLATION (Google Translate ë¬´ë£Œ API) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function translateText(viText){
  return DB.translateViaGoogle(viText);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BACKUP / RESTORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doBackup=async function(){
  const recSnap=await getDocs(collection(fs,'records'));
  const records=recSnap.docs.map(d=>d.data());
  const backup={...appData,records,exportedAt:new Date().toISOString()};
  const json=JSON.stringify(backup,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='laviespa_backup_'+new Date().toISOString().slice(0,10)+'.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
};

window.doRestore=async function(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=async function(e){
    try{
      const data=JSON.parse(e.target.result);
      // Restore config
      await setDoc(doc(fs,'config','main'),{categories:data.categories||[],menus:data.menus||[],beds:data.beds||[]});
      // Restore therapists
      for(const t of (data.therapists||[])){await setDoc(doc(fs,'therapists',t.id),t);}
      // Restore records
      for(const r of (data.records||[])){await setDoc(doc(fs,'records',r.id),r);}
      alert('âœ… KhÃ´i phá»¥c thÃ nh cÃ´ng!');
      location.reload();
    }catch(err){alert('âŒ File khÃ´ng há»£p lá»‡!');}
  };
  reader.readAsText(file);
  input.value='';
};

window.exportData=async function(type){
  if(type==='records'){
    const snap=await getDocs(collection(fs,'records'));
    const recs=snap.docs.map(d=>d.data()).filter(r=>r.status==='completed');
    DB.exportToCSV('laviespa_lichsu.csv',
      ['Thá»i gian','Dá»‹ch vá»¥','Ká»¹ thuáº­t viÃªn','GiÆ°á»ng','Thá»i lÆ°á»£ng','Doanh thu','Thanh toÃ¡n','Ghi chÃº'],
      recs.map(r=>[DB.fmtDateTime(r.completedTime||r.startTime),r.menuNameVi,r.therapistName||'',r.bedName||'',r.duration?r.duration+' phÃºt':'',r.amount||0,r.paymentMethod==='cash'?'Tiá»n máº·t':r.paymentMethod==='bank'?'Chuyá»ƒn khoáº£n':'',r.note||'']));
  } else if(type==='menus'){
    DB.exportToCSV('laviespa_dichvu.csv',
      ['Danh má»¥c','TÃªn dá»‹ch vá»¥','MÃ´ táº£','GiÃ¡','Tráº¡ng thÃ¡i'],
      appData.menus.map(m=>{
        const cat=appData.categories.find(c=>c.id===m.catId);
        const ps=m.prices.map(p=>(p.duration?p.duration+'ph ':p.label?p.label+' ':'')+DB.fmtMoney(p.amount)).join(' | ');
        return [cat?cat.nameVi:'',m.nameVi,m.descVi||'',ps,m.active?'Hiá»‡n':'áº¨n'];
      }));
  } else if(type==='therapists'){
    DB.exportToCSV('laviespa_ktv.csv',
      ['TÃªn','Äiá»‡n thoáº¡i','TÃ i khoáº£n ngÃ¢n hÃ ng','Tráº¡ng thÃ¡i'],
      appData.therapists.map(t=>[t.name,t.phone||'',t.bank||'',t.active!==false?'Hoáº¡t Ä‘á»™ng':'Nghá»‰']));
  }
};

window.resetAll=async function(){
  if(!confirm('âš ï¸ XÃ“A TOÃ€N Bá»˜ dá»¯ liá»‡u trÃªn Firestore?\nHÃ nh Ä‘á»™ng KHÃ”NG THá»‚ hoÃ n tÃ¡c!')) return;
  if(!confirm('XÃ¡c nháº­n láº§n 2: Thá»±c sá»± xÃ³a táº¥t cáº£?')) return;
  // Delete all docs
  const colls=['records','sessions','therapists'];
  for(const c of colls){const s=await getDocs(collection(fs,c));for(const d of s.docs) await deleteDoc(d.ref);}
  await deleteDoc(doc(fs,'config','main'));
  alert('ÄÃ£ xÃ³a. Trang sáº½ táº£i láº¡i.');
  location.reload();
};

let _retries=0;
async function _loadRetry(){
  try{await loadAll();}
  catch(e){
    _retries++;
    if(_retries<3){setTimeout(_loadRetry,2000);}
    else{const lt=document.querySelector('.loading-screen div:last-child');if(lt)lt.textContent='Lá»—i káº¿t ná»‘i. Vui lÃ²ng táº£i láº¡i.';}
  }
}
_loadRetry();
</script>
</body>
</html>
