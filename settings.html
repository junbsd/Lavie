<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lavie Spa - CÃ i Ä‘áº·t</title>
<script src="db.js"></script>
<style>
:root{
  --bg:#F5F7FA;--card:#fff;--border:#E2E8F0;--brown:#3E2310;--brown2:#5C3A1A;
  --gold:#96621A;--gold-mid:#B87D2E;--green:#16A34A;--green-light:#DCFCE7;
  --red:#DC2626;--red-light:#FEE2E2;--blue:#2563EB;--blue-light:#DBEAFE;
  --yellow:#D97706;--yellow-light:#FEF3C7;--text:#1E293B;--text2:#475569;--text3:#94A3B8;
  --shadow:rgba(0,0,0,0.06);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans','Segoe UI',sans-serif;min-height:100vh;}

.topbar{background:var(--brown);padding:11px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.topbar-logo{font-size:15px;font-weight:700;color:#E8C878;}
.topbar-nav{display:flex;gap:4px;}
.tnav{color:rgba(255,255,255,0.65);font-size:11px;padding:5px 10px;border-radius:12px;text-decoration:none;border:1px solid transparent;}
.tnav:hover,.tnav.active{background:rgba(255,255,255,0.15);color:#fff;}

.page-tabs{background:#fff;border-bottom:2px solid var(--border);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 4px;}
.page-tabs::-webkit-scrollbar{display:none;}
.ptab{flex-shrink:0;padding:11px 16px;font-size:12.5px;font-weight:600;color:var(--text2);cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;transition:all 0.2s;}
.ptab.active{color:var(--gold);border-bottom-color:var(--gold);}

.page-content{padding:14px;max-width:600px;margin:0 auto;display:none;}
.page-content.active{display:block;}

.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 6px var(--shadow);border:1px solid var(--border);}
.card-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}

/* LIST */
.list-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);gap:8px;}
.list-item:last-child{border-bottom:none;padding-bottom:0;}
.li-info{flex:1;min-width:0;}
.li-name{font-size:13.5px;font-weight:700;color:var(--text);}
.li-sub{font-size:11px;color:var(--text3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.li-actions{display:flex;gap:6px;flex-shrink:0;}
.btn-icon{width:32px;height:32px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.15s;}
.btn-edit-ic{background:var(--blue-light);color:var(--blue);}
.btn-del-ic{background:var(--red-light);color:var(--red);}
.btn-toggle-ic{background:var(--yellow-light);color:var(--yellow);}

/* TAGS */
.tag{display:inline-block;padding:2px 7px;border-radius:6px;font-size:10px;font-weight:700;margin-left:6px;vertical-align:middle;}
.tag-on{background:var(--green-light);color:var(--green);}
.tag-off{background:var(--border);color:var(--text3);}
.tag-translated{background:var(--blue-light);color:var(--blue);}

/* BUTTONS */
.btn-add-full{width:100%;padding:11px;border-radius:9px;background:var(--gold);color:#fff;font-size:13px;font-weight:700;border:none;cursor:pointer;margin-top:10px;}
.btn-add-full:hover{background:var(--brown2);}

/* FORM */
.field-lbl{font-size:12px;font-weight:700;color:var(--text2);margin:11px 0 4px;}
.field-lbl:first-child{margin-top:0;}
.field-input,.field-select,.field-textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13.5px;font-family:inherit;color:var(--text);background:#fff;}
.field-textarea{resize:vertical;min-height:65px;line-height:1.5;}
.field-input:focus,.field-select:focus,.field-textarea:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(150,98,26,0.1);}

/* PRICE ROWS */
.price-rows-wrap{border:1.5px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:4px;}
.price-row-form{display:flex;gap:0;align-items:center;border-bottom:1px solid var(--border);}
.price-row-form:last-child{border-bottom:none;}
.price-row-form input{flex:1;padding:9px 10px;border:none;font-size:13px;font-family:inherit;background:transparent;color:var(--text);}
.price-row-form input:focus{outline:none;background:var(--blue-light);}
.price-row-form .divider{width:1px;background:var(--border);height:38px;flex-shrink:0;}
.price-row-form .del-price{width:36px;height:38px;background:transparent;border:none;color:var(--red);cursor:pointer;font-size:16px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.price-row-form .del-price:hover{background:var(--red-light);}
.btn-add-price{padding:7px 12px;border-radius:7px;background:var(--blue-light);color:var(--blue);border:1px solid var(--blue);font-size:12px;cursor:pointer;font-weight:600;}

/* TRANSLATE STATUS */
.trans-status{font-size:12px;padding:8px 11px;border-radius:7px;margin-top:8px;display:none;line-height:1.4;}
.trans-status.loading{background:var(--yellow-light);color:var(--yellow);display:block;}
.trans-status.done{background:var(--green-light);color:var(--green);display:block;}
.trans-status.error{background:var(--red-light);color:var(--red);display:block;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:500;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:#fff;border-radius:22px 22px 0 0;padding:20px 18px 34px;width:100%;max-width:540px;max-height:93vh;overflow-y:auto;animation:slideUp 0.28s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-drag{width:40px;height:4px;background:#ddd;border-radius:4px;margin:0 auto 14px;}
.modal-title{font-size:17px;font-weight:700;color:var(--text);margin-bottom:14px;}
.modal-btn-row{display:flex;gap:8px;margin-top:16px;}
.btn-primary{flex:1;padding:12px;border-radius:9px;background:var(--gold);color:#fff;font-size:14px;font-weight:700;border:none;cursor:pointer;}
.btn-primary:disabled{background:#ccc;cursor:not-allowed;}
.btn-secondary{flex:1;padding:12px;border-radius:9px;background:var(--bg);color:var(--text2);font-size:14px;font-weight:600;border:1.5px solid var(--border);cursor:pointer;}

/* BACKUP */
.chip-row{display:flex;gap:8px;flex-wrap:wrap;}
.chip{display:inline-flex;align-items:center;gap:5px;padding:9px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;}
.chip-gold{background:var(--gold);color:#fff;}
.chip-green{background:var(--green-light);color:var(--green);border:1.5px solid var(--green);}
.chip-blue{background:var(--blue-light);color:var(--blue);border:1.5px solid var(--blue);}
.chip-red{background:var(--red-light);color:var(--red);border:1.5px solid var(--red);}

/* NOTE SEARCH */
.search-wrap{position:relative;margin-bottom:12px;}
.search-input{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:inherit;color:var(--text);}
.search-input:focus{outline:none;border-color:var(--gold);}
.note-card{background:var(--card);border-radius:9px;padding:10px 12px;margin-bottom:7px;border:1px solid var(--border);box-shadow:0 1px 4px var(--shadow);}
.note-menu{font-size:13px;font-weight:700;color:var(--text);}
.note-meta{font-size:11px;color:var(--text3);margin-top:2px;}
.note-body{font-size:12px;color:var(--blue);margin-top:5px;padding:5px 8px;background:var(--blue-light);border-radius:6px;}
mark{background:#FFF176;padding:1px 2px;border-radius:2px;}

.danger-zone{border:1.5px solid var(--red);border-radius:10px;padding:14px;}
.danger-title{font-size:13px;font-weight:700;color:var(--red);margin-bottom:6px;}
.danger-desc{font-size:12px;color:var(--text3);margin-bottom:10px;}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-logo">ğŸŒ¿ Lavie Spa - CÃ i Ä‘áº·t</div>
  <div class="topbar-nav">
    <a class="tnav" href="index.html">ğŸ“‹ Menu</a>
    <a class="tnav" href="admin.html">âš™ï¸ Quáº£n lÃ½</a>
    <a class="tnav active" href="settings.html">ğŸ›  CÃ i Ä‘áº·t</a>
  </div>
</div>

<div class="page-tabs">
  <div class="ptab active" onclick="showPage('therapists')">ğŸ‘¤ Ká»¹ thuáº­t viÃªn</div>
  <div class="ptab" onclick="showPage('menus')">ğŸ“‹ Menu dá»‹ch vá»¥</div>
  <div class="ptab" onclick="showPage('categories')">ğŸ—‚ Danh má»¥c</div>
  <div class="ptab" onclick="showPage('notes')">ğŸ” TÃ¬m ghi chÃº</div>
  <div class="ptab" onclick="showPage('backup')">ğŸ’¾ Sao lÆ°u</div>
</div>

<!-- THERAPISTS -->
<div id="page-therapists" class="page-content active">
  <div class="card">
    <div class="card-title">
      Danh sÃ¡ch ká»¹ thuáº­t viÃªn
      <button class="btn-icon btn-edit-ic" style="width:auto;padding:0 12px;font-size:12px;font-weight:700;" onclick="openThrModal(null)">+ ThÃªm</button>
    </div>
    <div id="thrList"></div>
    <button class="btn-add-full" onclick="openThrModal(null)">+ ThÃªm ká»¹ thuáº­t viÃªn má»›i</button>
  </div>
</div>

<!-- MENUS -->
<div id="page-menus" class="page-content">
  <div class="card" style="padding:12px 14px;">
    <div class="field-lbl" style="margin-top:0">Lá»c theo danh má»¥c</div>
    <select class="field-select" id="menuCatFilter" onchange="renderMenuList()">
      <option value="">-- Táº¥t cáº£ danh má»¥c --</option>
    </select>
  </div>
  <div id="menuList"></div>
  <button class="btn-add-full" onclick="openMenuModal(null)">+ ThÃªm dá»‹ch vá»¥ má»›i</button>
</div>

<!-- CATEGORIES -->
<div id="page-categories" class="page-content">
  <div class="card">
    <div class="card-title">
      Danh má»¥c dá»‹ch vá»¥
      <button class="btn-icon btn-edit-ic" style="width:auto;padding:0 12px;font-size:12px;font-weight:700;" onclick="openCatModal(null)">+ ThÃªm</button>
    </div>
    <div id="catList"></div>
    <button class="btn-add-full" onclick="openCatModal(null)">+ ThÃªm danh má»¥c má»›i</button>
  </div>
</div>

<!-- NOTE SEARCH -->
<div id="page-notes" class="page-content">
  <div class="card">
    <div class="card-title">ğŸ” TÃ¬m kiáº¿m ghi chÃº</div>
    <div class="search-wrap">
      <input class="search-input" id="noteSearchInput" type="text" placeholder="Nháº­p tá»« khoÃ¡: tÃªn dá»‹ch vá»¥, ká»¹ thuáº­t viÃªn, ná»™i dung ghi chÃº..." oninput="renderNoteSearch()">
    </div>
    <div id="noteSearchResults"></div>
  </div>
</div>

<!-- BACKUP -->
<div id="page-backup" class="page-content">
  <div class="card">
    <div class="card-title">ğŸ’¾ Sao lÆ°u & KhÃ´i phá»¥c dá»¯ liá»‡u</div>
    <p style="font-size:12.5px;color:var(--text2);margin-bottom:14px;line-height:1.6;">Sao lÆ°u toÃ n bá»™ dá»¯ liá»‡u (menu, ká»¹ thuáº­t viÃªn, lá»‹ch sá»­ dá»‹ch vá»¥) thÃ nh file JSON. CÃ³ thá»ƒ khÃ´i phá»¥c láº¡i báº¥t ká»³ lÃºc nÃ o.</p>
    <div class="chip-row">
      <button class="chip chip-gold" onclick="doBackup()">ğŸ“¦ Táº£i vá» (JSON)</button>
      <label class="chip chip-green" style="cursor:pointer">
        ğŸ“‚ KhÃ´i phá»¥c
        <input type="file" accept=".json" style="display:none" onchange="doRestore(this)">
      </label>
    </div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“¥ Xuáº¥t dá»¯ liá»‡u ra Excel (CSV)</div>
    <div class="chip-row">
      <button class="chip chip-blue" onclick="exportData('records')">ğŸ“‹ Lá»‹ch sá»­ dá»‹ch vá»¥</button>
      <button class="chip chip-blue" onclick="exportData('menus')">ğŸ—’ Danh sÃ¡ch dá»‹ch vá»¥</button>
      <button class="chip chip-blue" onclick="exportData('therapists')">ğŸ‘¥ Ká»¹ thuáº­t viÃªn</button>
    </div>
  </div>

  <div class="card">
    <div class="danger-zone">
      <div class="danger-title">âš ï¸ VÃ¹ng nguy hiá»ƒm</div>
      <div class="danger-desc">XÃ³a toÃ n bá»™ dá»¯ liá»‡u vÃ  reset vá» máº·c Ä‘á»‹nh. KhÃ´ng thá»ƒ hoÃ n tÃ¡c! HÃ£y sao lÆ°u trÆ°á»›c.</div>
      <button class="chip chip-red" onclick="resetAllData()">ğŸ—‘ XÃ³a toÃ n bá»™ dá»¯ liá»‡u</button>
    </div>
  </div>
</div>

<!-- â”€â”€ THERAPIST MODAL â”€â”€ -->
<div class="modal-overlay" id="thrModal" onclick="if(event.target===this)closeThrModal()">
  <div class="modal-sheet">
    <div class="modal-drag"></div>
    <div class="modal-title" id="thrModalTitle">ThÃªm ká»¹ thuáº­t viÃªn</div>
    <div class="field-lbl">TÃªn ká»¹ thuáº­t viÃªn <span style="color:var(--red)">*</span></div>
    <input class="field-input" id="thrName" type="text" placeholder="Nháº­p tÃªn...">
    <div class="field-lbl">Sá»‘ Ä‘iá»‡n thoáº¡i</div>
    <input class="field-input" id="thrPhone" type="tel" placeholder="0901 234 567">
    <div class="field-lbl">TÃ i khoáº£n ngÃ¢n hÃ ng</div>
    <input class="field-input" id="thrBank" type="text" placeholder="VD: MB Bank - 012345678">
    <div class="modal-btn-row">
      <button class="btn-secondary" onclick="closeThrModal()">Há»§y</button>
      <button class="btn-primary" onclick="saveThr()">ğŸ’¾ LÆ°u</button>
    </div>
  </div>
</div>

<!-- â”€â”€ MENU MODAL â”€â”€ -->
<div class="modal-overlay" id="menuModal" onclick="if(event.target===this)closeMenuModal()">
  <div class="modal-sheet">
    <div class="modal-drag"></div>
    <div class="modal-title" id="menuModalTitle">ThÃªm dá»‹ch vá»¥</div>

    <div class="field-lbl">Danh má»¥c <span style="color:var(--red)">*</span></div>
    <select class="field-select" id="menuCatId"></select>

    <div class="field-lbl">TÃªn dá»‹ch vá»¥ (Tiáº¿ng Viá»‡t) <span style="color:var(--red)">*</span></div>
    <input class="field-input" id="menuNameVi" type="text" placeholder="VD: Massage cá»• vai gÃ¡y trá»‹ liá»‡u">

    <div class="field-lbl">MÃ´ táº£ (Tiáº¿ng Viá»‡t)</div>
    <textarea class="field-textarea" id="menuDescVi" placeholder="VD: NgÃ¢m chÃ¢n tháº£o dÆ°á»£c + massage + Ä‘Ã¡ nÃ³ng..."></textarea>

    <div class="field-lbl">Má»©c giÃ¡ <span style="color:var(--text3);font-weight:400;font-size:11px">(thá»i lÆ°á»£ng + giÃ¡ VNÄ)</span></div>
    <div class="price-rows-wrap" id="priceRowsWrap"></div>
    <button class="btn-add-price" style="margin-top:6px" onclick="addPriceRow('','')">+ ThÃªm má»©c giÃ¡</button>

    <div class="trans-status" id="menuTransStatus"></div>

    <div class="modal-btn-row">
      <button class="btn-secondary" onclick="closeMenuModal()">Há»§y</button>
      <button class="btn-primary" id="menuSaveBtn" onclick="saveMenu()">ğŸ’¾ LÆ°u & Tá»± Ä‘á»™ng dá»‹ch</button>
    </div>
  </div>
</div>

<!-- â”€â”€ CATEGORY MODAL â”€â”€ -->
<div class="modal-overlay" id="catModal" onclick="if(event.target===this)closeCatModal()">
  <div class="modal-sheet">
    <div class="modal-drag"></div>
    <div class="modal-title" id="catModalTitle">ThÃªm danh má»¥c</div>
    <div class="field-lbl">TÃªn danh má»¥c (Tiáº¿ng Viá»‡t) <span style="color:var(--red)">*</span></div>
    <input class="field-input" id="catNameVi" type="text" placeholder="VD: Massage Trá»‹ Liá»‡u">
    <div class="field-lbl">Icon (emoji)</div>
    <input class="field-input" id="catIcon" type="text" placeholder="ğŸ’†" maxlength="4" style="font-size:24px;text-align:center;">
    <div class="trans-status" id="catTransStatus"></div>
    <div class="modal-btn-row">
      <button class="btn-secondary" onclick="closeCatModal()">Há»§y</button>
      <button class="btn-primary" onclick="saveCat()">ğŸ’¾ LÆ°u</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ SINGLE GLOBAL STATE â”€â”€
var appDB;
var editingThrId  = null;
var editingMenuId = null;
var editingCatId  = null;
var priceRowCount = 0;

function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ INIT â”€â”€
function init() {
  appDB = DB.loadDB();
  renderTherapists();
  renderMenuList();
  renderCatList();
  populateCatDropdowns();
}

function showPage(name) {
  var pages = ['therapists','menus','categories','notes','backup'];
  pages.forEach(function(p) {
    document.getElementById('page-' + p).classList.toggle('active', p === name);
  });
  document.querySelectorAll('.ptab').forEach(function(t, i) {
    t.classList.toggle('active', pages[i] === name);
  });
  if (name === 'notes') renderNoteSearch();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// THERAPISTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTherapists() {
  appDB = DB.loadDB();
  var el = document.getElementById('thrList');
  if (!appDB.therapists || appDB.therapists.length === 0) {
    el.innerHTML = '<p style="color:var(--text3);font-size:13px;padding:8px 0">ChÆ°a cÃ³ ká»¹ thuáº­t viÃªn nÃ o.</p>';
    return;
  }
  el.innerHTML = appDB.therapists.map(function(t) {
    var isActive = t.active !== false;
    var sub = [t.phone, t.bank].filter(Boolean).join(' | ');
    return '<div class="list-item">' +
      '<div class="li-info">' +
        '<div class="li-name">' + escHtml(t.name) +
          '<span class="tag ' + (isActive ? 'tag-on' : 'tag-off') + '">' + (isActive ? 'Hoáº¡t Ä‘á»™ng' : 'Nghá»‰') + '</span>' +
        '</div>' +
        '<div class="li-sub">' + escHtml(sub || 'ChÆ°a cÃ³ thÃ´ng tin') + '</div>' +
      '</div>' +
      '<div class="li-actions">' +
        '<button class="btn-icon btn-toggle-ic" onclick="toggleThr(\'' + t.id + '\')" title="Báº­t/Táº¯t">â¸</button>' +
        '<button class="btn-icon btn-edit-ic" onclick="openThrModal(\'' + t.id + '\')">âœï¸</button>' +
        '<button class="btn-icon btn-del-ic" onclick="deleteThr(\'' + t.id + '\')">ğŸ—‘</button>' +
      '</div></div>';
  }).join('');
}

function openThrModal(id) {
  editingThrId = id;
  var t = id ? (appDB.therapists || []).find(function(x){ return x.id === id; }) : null;
  document.getElementById('thrModalTitle').textContent = id ? 'Sá»­a ká»¹ thuáº­t viÃªn' : 'ThÃªm ká»¹ thuáº­t viÃªn má»›i';
  document.getElementById('thrName').value  = t ? (t.name  || '') : '';
  document.getElementById('thrPhone').value = t ? (t.phone || '') : '';
  document.getElementById('thrBank').value  = t ? (t.bank  || '') : '';
  document.getElementById('thrModal').classList.add('show');
  setTimeout(function(){ document.getElementById('thrName').focus(); }, 150);
}

function closeThrModal() {
  document.getElementById('thrModal').classList.remove('show');
  editingThrId = null;
}

function saveThr() {
  var name = document.getElementById('thrName').value.trim();
  if (!name) {
    alert('Vui lÃ²ng nháº­p tÃªn ká»¹ thuáº­t viÃªn!');
    document.getElementById('thrName').focus();
    return;
  }
  var phone = document.getElementById('thrPhone').value.trim();
  var bank  = document.getElementById('thrBank').value.trim();

  // Always reload fresh from storage before modifying
  var freshDB = DB.loadDB();

  if (editingThrId) {
    // Edit existing
    var found = false;
    for (var i = 0; i < freshDB.therapists.length; i++) {
      if (freshDB.therapists[i].id === editingThrId) {
        freshDB.therapists[i].name  = name;
        freshDB.therapists[i].phone = phone;
        freshDB.therapists[i].bank  = bank;
        found = true;
        break;
      }
    }
    if (!found) {
      alert('KhÃ´ng tÃ¬m tháº¥y ká»¹ thuáº­t viÃªn!');
      return;
    }
  } else {
    // Add new
    freshDB.therapists.push({
      id:     DB.genId('t'),
      name:   name,
      phone:  phone,
      bank:   bank,
      active: true
    });
  }

  DB.saveDB(freshDB);
  appDB = freshDB;
  closeThrModal();
  renderTherapists();
}

function toggleThr(id) {
  var freshDB = DB.loadDB();
  for (var i = 0; i < freshDB.therapists.length; i++) {
    if (freshDB.therapists[i].id === id) {
      freshDB.therapists[i].active = (freshDB.therapists[i].active === false) ? true : false;
      break;
    }
  }
  DB.saveDB(freshDB);
  appDB = freshDB;
  renderTherapists();
}

function deleteThr(id) {
  if (!confirm('XÃ³a ká»¹ thuáº­t viÃªn nÃ y?')) return;
  var freshDB = DB.loadDB();
  freshDB.therapists = freshDB.therapists.filter(function(t){ return t.id !== id; });
  DB.saveDB(freshDB);
  appDB = freshDB;
  renderTherapists();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MENUS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateCatDropdowns() {
  appDB = DB.loadDB();
  var opts = appDB.categories.map(function(c) {
    return '<option value="' + c.id + '">' + (c.icon||'') + ' ' + escHtml(c.nameVi) + '</option>';
  }).join('');
  var filterSel = document.getElementById('menuCatFilter');
  var modalSel  = document.getElementById('menuCatId');
  if (filterSel) filterSel.innerHTML = '<option value="">-- Táº¥t cáº£ danh má»¥c --</option>' + opts;
  if (modalSel)  modalSel.innerHTML  = '<option value="">-- Chá»n danh má»¥c --</option>' + opts;
}

function renderMenuList() {
  appDB = DB.loadDB();
  var filterVal = (document.getElementById('menuCatFilter') || {}).value || '';
  var menus = filterVal
    ? appDB.menus.filter(function(m){ return m.catId === filterVal; })
    : appDB.menus;

  // Group by category
  var groups = {};
  var groupOrder = [];
  menus.forEach(function(m) {
    var cat = (appDB.categories || []).find(function(c){ return c.id === m.catId; });
    var key = m.catId;
    if (!groups[key]) { groups[key] = {cat: cat, items: []}; groupOrder.push(key); }
    groups[key].items.push(m);
  });

  var el = document.getElementById('menuList');
  if (groupOrder.length === 0) {
    el.innerHTML = '<div class="card" style="text-align:center;color:var(--text3);padding:20px">ChÆ°a cÃ³ dá»‹ch vá»¥ nÃ o.</div>';
    return;
  }

  el.innerHTML = groupOrder.map(function(key) {
    var g = groups[key];
    var catName = g.cat ? ((g.cat.icon||'') + ' ' + g.cat.nameVi) : 'Danh má»¥c khÃ¡c';
    var itemsHtml = g.items.map(function(m) {
      var priceStr = m.prices.map(function(p) {
        return (p.duration ? p.duration + 'ph ' : '') + (p.label ? p.label + ' ' : '') + DB.fmtMoney(p.amount);
      }).join(' | ');
      var transCount = Object.keys(m.translations || {}).filter(function(k){ return !k.endsWith('_desc'); }).length;
      return '<div class="list-item">' +
        '<div class="li-info">' +
          '<div class="li-name">' + escHtml(m.nameVi) +
            '<span class="tag ' + (m.active ? 'tag-on' : 'tag-off') + '">' + (m.active ? 'Hiá»‡n' : 'áº¨n') + '</span>' +
            (transCount > 0 ? '<span class="tag tag-translated">âœ“ ' + transCount + ' ngÃ´n ngá»¯</span>' : '') +
          '</div>' +
          '<div class="li-sub">' + escHtml(priceStr) + '</div>' +
        '</div>' +
        '<div class="li-actions">' +
          '<button class="btn-icon btn-toggle-ic" onclick="toggleMenu(\'' + m.id + '\')" title="Hiá»‡n/áº¨n">ğŸ‘</button>' +
          '<button class="btn-icon btn-edit-ic" onclick="openMenuModal(\'' + m.id + '\')">âœï¸</button>' +
          '<button class="btn-icon btn-del-ic" onclick="deleteMenu(\'' + m.id + '\')">ğŸ—‘</button>' +
        '</div></div>';
    }).join('');
    return '<div class="card"><div class="card-title">' + escHtml(catName) + '</div>' + itemsHtml + '</div>';
  }).join('');
}

function addPriceRow(duration, amount) {
  priceRowCount++;
  var rowId = 'prow_' + priceRowCount;
  var wrap = document.getElementById('priceRowsWrap');
  var div = document.createElement('div');
  div.className = 'price-row-form';
  div.id = rowId;
  div.innerHTML =
    '<input type="text"   class="dur-inp"  placeholder="Thá»i lÆ°á»£ng (vd: 60)" value="' + escHtml(duration||'') + '">' +
    '<div class="divider"></div>' +
    '<input type="number" class="amt-inp"  placeholder="GiÃ¡ (VNÄ)"           value="' + (amount||'') + '">' +
    '<button type="button" class="del-price" onclick="document.getElementById(\'' + rowId + '\').remove()">âœ•</button>';
  wrap.appendChild(div);
}

function openMenuModal(id) {
  priceRowCount = 0;
  editingMenuId = id;
  appDB = DB.loadDB();
  var m = id ? (appDB.menus || []).find(function(x){ return x.id === id; }) : null;

  document.getElementById('menuModalTitle').textContent = id ? 'Sá»­a dá»‹ch vá»¥' : 'ThÃªm dá»‹ch vá»¥ má»›i';
  document.getElementById('menuNameVi').value = m ? (m.nameVi || '') : '';
  document.getElementById('menuDescVi').value = m ? (m.descVi || '') : '';
  document.getElementById('menuCatId').value  = m ? (m.catId  || '') : '';
  document.getElementById('menuTransStatus').className = 'trans-status';
  document.getElementById('menuTransStatus').textContent = '';
  document.getElementById('menuSaveBtn').disabled = false;

  // Price rows
  document.getElementById('priceRowsWrap').innerHTML = '';
  if (m && m.prices && m.prices.length > 0) {
    m.prices.forEach(function(p) {
      addPriceRow(p.duration || p.label || '', p.amount || '');
    });
  } else {
    addPriceRow('', '');
  }

  document.getElementById('menuModal').classList.add('show');
  setTimeout(function(){ document.getElementById('menuNameVi').focus(); }, 150);
}

function closeMenuModal() {
  document.getElementById('menuModal').classList.remove('show');
  editingMenuId = null;
}

async function saveMenu() {
  var nameVi = document.getElementById('menuNameVi').value.trim();
  var catId  = document.getElementById('menuCatId').value;
  var descVi = document.getElementById('menuDescVi').value.trim();

  if (!nameVi) { alert('Vui lÃ²ng nháº­p tÃªn dá»‹ch vá»¥!'); document.getElementById('menuNameVi').focus(); return; }
  if (!catId)  { alert('Vui lÃ²ng chá»n danh má»¥c!'); return; }

  // Collect prices
  var pRows = document.querySelectorAll('#priceRowsWrap .price-row-form');
  var prices = [];
  pRows.forEach(function(row) {
    var dur = (row.querySelector('.dur-inp').value || '').trim();
    var amt = parseInt(row.querySelector('.amt-inp').value || '0', 10) || 0;
    if (amt > 0) prices.push({ duration: dur, amount: amt });
  });
  if (prices.length === 0) { alert('Vui lÃ²ng nháº­p Ã­t nháº¥t 1 má»©c giÃ¡!'); return; }

  // Show translating
  var statusEl = document.getElementById('menuTransStatus');
  var saveBtn  = document.getElementById('menuSaveBtn');
  statusEl.className = 'trans-status loading';
  statusEl.textContent = 'ğŸ”„ Äang dá»‹ch tá»± Ä‘á»™ng sang 7 ngÃ´n ngá»¯... Vui lÃ²ng chá»';
  saveBtn.disabled = true;

  var translations = {};
  try {
    var nameT = await DB.translateToAllLangs(nameVi);
    var descT = descVi ? await DB.translateToAllLangs(descVi) : {};
    Object.assign(translations, nameT);
    Object.keys(descT).forEach(function(lang) { translations[lang + '_desc'] = descT[lang]; });
    statusEl.className = 'trans-status done';
    statusEl.textContent = 'âœ… ÄÃ£ dá»‹ch thÃ nh cÃ´ng sang ' + Object.keys(nameT).length + ' ngÃ´n ngá»¯!';
  } catch(e) {
    statusEl.className = 'trans-status error';
    statusEl.textContent = 'âš ï¸ KhÃ´ng dá»‹ch Ä‘Æ°á»£c tá»± Ä‘á»™ng â€” lÆ°u báº±ng tiáº¿ng Viá»‡t.';
  }

  var freshDB = DB.loadDB();
  if (editingMenuId) {
    for (var i = 0; i < freshDB.menus.length; i++) {
      if (freshDB.menus[i].id === editingMenuId) {
        freshDB.menus[i].catId   = catId;
        freshDB.menus[i].nameVi  = nameVi;
        freshDB.menus[i].descVi  = descVi;
        freshDB.menus[i].prices  = prices;
        freshDB.menus[i].translations = translations;
        break;
      }
    }
  } else {
    freshDB.menus.push({
      id: DB.genId('m'), catId: catId, nameVi: nameVi,
      descVi: descVi, prices: prices, translations: translations, active: true
    });
  }
  DB.saveDB(freshDB);
  appDB = freshDB;

  setTimeout(function() {
    closeMenuModal();
    renderMenuList();
    saveBtn.disabled = false;
  }, 1200);
}

function toggleMenu(id) {
  var freshDB = DB.loadDB();
  for (var i = 0; i < freshDB.menus.length; i++) {
    if (freshDB.menus[i].id === id) {
      freshDB.menus[i].active = !freshDB.menus[i].active;
      break;
    }
  }
  DB.saveDB(freshDB);
  appDB = freshDB;
  renderMenuList();
}

function deleteMenu(id) {
  if (!confirm('XÃ³a dá»‹ch vá»¥ nÃ y?')) return;
  var freshDB = DB.loadDB();
  freshDB.menus = freshDB.menus.filter(function(m){ return m.id !== id; });
  DB.saveDB(freshDB);
  appDB = freshDB;
  renderMenuList();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CATEGORIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCatList() {
  appDB = DB.loadDB();
  var el = document.getElementById('catList');
  if (!appDB.categories || appDB.categories.length === 0) {
    el.innerHTML = '<p style="color:var(--text3);font-size:13px;padding:8px 0">ChÆ°a cÃ³ danh má»¥c nÃ o.</p>';
    return;
  }
  el.innerHTML = appDB.categories.map(function(c) {
    var menuCount = (appDB.menus || []).filter(function(m){ return m.catId === c.id; }).length;
    var transCount = Object.keys(c.translations || {}).length;
    return '<div class="list-item">' +
      '<div class="li-info">' +
        '<div class="li-name">' + escHtml((c.icon||'') + ' ' + c.nameVi) +
          (transCount > 0 ? '<span class="tag tag-translated">âœ“ ÄÃ£ dá»‹ch</span>' : '') +
        '</div>' +
        '<div class="li-sub">' + menuCount + ' dá»‹ch vá»¥</div>' +
      '</div>' +
      '<div class="li-actions">' +
        '<button class="btn-icon btn-edit-ic" onclick="openCatModal(\'' + c.id + '\')">âœï¸</button>' +
        '<button class="btn-icon btn-del-ic"  onclick="deleteCat(\'' + c.id + '\')">ğŸ—‘</button>' +
      '</div></div>';
  }).join('');
}

function openCatModal(id) {
  editingCatId = id;
  appDB = DB.loadDB();
  var c = id ? (appDB.categories || []).find(function(x){ return x.id === id; }) : null;
  document.getElementById('catModalTitle').textContent = id ? 'Sá»­a danh má»¥c' : 'ThÃªm danh má»¥c má»›i';
  document.getElementById('catNameVi').value = c ? (c.nameVi || '') : '';
  document.getElementById('catIcon').value   = c ? (c.icon   || '') : '';
  document.getElementById('catTransStatus').className = 'trans-status';
  document.getElementById('catTransStatus').textContent = '';
  document.getElementById('catModal').classList.add('show');
  setTimeout(function(){ document.getElementById('catNameVi').focus(); }, 150);
}

function closeCatModal() {
  document.getElementById('catModal').classList.remove('show');
  editingCatId = null;
}

async function saveCat() {
  var nameVi = document.getElementById('catNameVi').value.trim();
  if (!nameVi) { alert('Vui lÃ²ng nháº­p tÃªn danh má»¥c!'); return; }
  var icon = document.getElementById('catIcon').value.trim() || 'ğŸ“‹';

  var statusEl = document.getElementById('catTransStatus');
  statusEl.className = 'trans-status loading';
  statusEl.textContent = 'ğŸ”„ Äang dá»‹ch...';

  var translations = {};
  try {
    translations = await DB.translateToAllLangs(nameVi);
    statusEl.className = 'trans-status done';
    statusEl.textContent = 'âœ… ÄÃ£ dá»‹ch!';
  } catch(e) {
    statusEl.className = 'trans-status error';
    statusEl.textContent = 'âš ï¸ Lá»—i dá»‹ch.';
  }

  var freshDB = DB.loadDB();
  if (editingCatId) {
    for (var i = 0; i < freshDB.categories.length; i++) {
      if (freshDB.categories[i].id === editingCatId) {
        freshDB.categories[i].nameVi = nameVi;
        freshDB.categories[i].icon   = icon;
        freshDB.categories[i].translations = translations;
        break;
      }
    }
  } else {
    freshDB.categories.push({ id: DB.genId('c'), nameVi: nameVi, icon: icon, translations: translations });
  }
  DB.saveDB(freshDB);
  appDB = freshDB;
  setTimeout(function() {
    closeCatModal();
    renderCatList();
    populateCatDropdowns();
    renderMenuList();
  }, 900);
}

function deleteCat(id) {
  var freshDB = DB.loadDB();
  var cnt = (freshDB.menus || []).filter(function(m){ return m.catId === id; }).length;
  if (!confirm('XÃ³a danh má»¥c nÃ y?' + (cnt > 0 ? '\nâš ï¸ ' + cnt + ' dá»‹ch vá»¥ trong danh má»¥c nÃ y cÅ©ng sáº½ bá»‹ xÃ³a!' : ''))) return;
  freshDB.categories = freshDB.categories.filter(function(c){ return c.id !== id; });
  if (cnt > 0) freshDB.menus = freshDB.menus.filter(function(m){ return m.catId !== id; });
  DB.saveDB(freshDB);
  appDB = freshDB;
  renderCatList();
  populateCatDropdowns();
  renderMenuList();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NOTE SEARCH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNoteSearch() {
  appDB = DB.loadDB();
  var q = (document.getElementById('noteSearchInput').value || '').trim().toLowerCase();
  var all = (appDB.records || []).filter(function(r) { return r.note && r.note.trim(); });

  if (!q) {
    var el = document.getElementById('noteSearchResults');
    if (all.length === 0) {
      el.innerHTML = '<p style="color:var(--text3);font-size:13px;text-align:center;padding:20px">ChÆ°a cÃ³ ghi chÃº nÃ o Ä‘Æ°á»£c lÆ°u.</p>';
    } else {
      el.innerHTML = '<p style="color:var(--text3);font-size:12px;margin-bottom:8px">Hiá»ƒn thá»‹ ' + Math.min(all.length,30) + '/' + all.length + ' ghi chÃº gáº§n nháº¥t</p>' +
        all.slice(0,30).sort(function(a,b){ return (b.completedTime||b.startTime)-(a.completedTime||a.startTime); })
          .map(function(r){ return noteCard(r, ''); }).join('');
    }
    return;
  }

  var results = all.filter(function(r) {
    return (r.note||'').toLowerCase().includes(q) ||
           (r.menuNameVi||'').toLowerCase().includes(q) ||
           (r.therapistName||'').toLowerCase().includes(q);
  }).sort(function(a,b){ return (b.completedTime||b.startTime)-(a.completedTime||a.startTime); });

  var el = document.getElementById('noteSearchResults');
  if (results.length === 0) {
    el.innerHTML = '<p style="color:var(--text3);font-size:13px;text-align:center;padding:20px">KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£ cho "<b>' + escHtml(q) + '</b>"</p>';
    return;
  }
  el.innerHTML = '<p style="color:var(--text3);font-size:12px;margin-bottom:8px">TÃ¬m tháº¥y ' + results.length + ' káº¿t quáº£</p>' +
    results.map(function(r){ return noteCard(r, q); }).join('');
}

function noteCard(r, q) {
  function hl(txt) {
    if (!q || !txt) return escHtml(txt||'');
    return escHtml(txt).replace(
      new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'gi'),
      '<mark>$1</mark>'
    );
  }
  return '<div class="note-card">' +
    '<div class="note-menu">' + hl(r.menuNameVi) + '</div>' +
    '<div class="note-meta">ğŸ‘¤ ' + hl(r.therapistName||'â€”') + ' &nbsp;|&nbsp; ' + DB.fmtDateTime(r.completedTime||r.startTime) + ' &nbsp;|&nbsp; ' + DB.fmtMoney(r.amount) + '</div>' +
    '<div class="note-body">ğŸ“ ' + hl(r.note) + '</div>' +
    '</div>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BACKUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doBackup() { DB.backupDB(DB.loadDB()); }

function doRestore(input) {
  var file = input.files[0];
  if (!file) return;
  DB.restoreDB(file, function(ok, data) {
    if (ok) {
      appDB = data;
      init();
      alert('âœ… KhÃ´i phá»¥c thÃ nh cÃ´ng!');
    } else {
      alert('âŒ File khÃ´ng há»£p lá»‡ hoáº·c bá»‹ lá»—i!');
    }
    input.value = '';
  });
}

function exportData(type) {
  var freshDB = DB.loadDB();
  if (type === 'records') {
    DB.exportToCSV('laviespa_lichsu.csv',
      ['Thá»i gian','Dá»‹ch vá»¥','Ká»¹ thuáº­t viÃªn','GiÆ°á»ng','Thá»i lÆ°á»£ng','Doanh thu','Ghi chÃº'],
      (freshDB.records||[]).filter(function(r){ return r.status==='completed'; }).map(function(r){
        return [DB.fmtDateTime(r.completedTime||r.startTime), r.menuNameVi, r.therapistName||'', r.bedName||'',
                r.duration?r.duration+' phÃºt':'', r.amount||0, r.note||''];
      })
    );
  } else if (type === 'menus') {
    DB.exportToCSV('laviespa_dichvu.csv',
      ['Danh má»¥c','TÃªn dá»‹ch vá»¥','MÃ´ táº£','GiÃ¡','Tráº¡ng thÃ¡i'],
      (freshDB.menus||[]).map(function(m){
        var cat = (freshDB.categories||[]).find(function(c){ return c.id===m.catId; });
        var priceStr = m.prices.map(function(p){ return (p.duration?p.duration+'ph ':'')+DB.fmtMoney(p.amount); }).join(' | ');
        return [cat?cat.nameVi:'', m.nameVi, m.descVi||'', priceStr, m.active?'Hiá»‡n':'áº¨n'];
      })
    );
  } else if (type === 'therapists') {
    DB.exportToCSV('laviespa_ktv.csv',
      ['TÃªn','Äiá»‡n thoáº¡i','TÃ i khoáº£n ngÃ¢n hÃ ng','Tráº¡ng thÃ¡i'],
      (freshDB.therapists||[]).map(function(t){
        return [t.name, t.phone||'', t.bank||'', t.active!==false?'Hoáº¡t Ä‘á»™ng':'Nghá»‰'];
      })
    );
  }
}

function resetAllData() {
  if (!confirm('âš ï¸ XÃ“A TOÃ€N Bá»˜ Dá»® LIá»†U?\nHÃ nh Ä‘á»™ng nÃ y KHÃ”NG THá»‚ hoÃ n tÃ¡c.\nHÃ£y sao lÆ°u trÆ°á»›c!')) return;
  if (!confirm('XÃ¡c nháº­n láº§n 2: Thá»±c sá»± muá»‘n xÃ³a táº¥t cáº£?')) return;
  localStorage.removeItem('laviespa_v3');
  alert('ÄÃ£ xÃ³a. Trang sáº½ táº£i láº¡i.');
  location.reload();
}

window.addEventListener('load', function() { init(); });
</script>
</body>
</html>
