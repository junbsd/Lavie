<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Lavie Spa - B·∫£ng Gi√°</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;0,700;1,500&family=Noto+Sans:wght@400;500;600&family=Noto+Sans+KR:wght@400;500;600&family=Noto+Sans+JP:wght@400;500&display=swap" rel="stylesheet">
<script src="db.js"></script>
<style>
:root{--bg:#FAF6F0;--bg2:#F0E8D8;--gold:#96621A;--gold-mid:#B87D2E;--brown:#3E2310;--brown2:#5C3A1A;--text:#2C1A0A;--text2:#5A3D20;--text3:#6B4A28;--border:#CEB992;--card:#FFF;--card2:#FDF9F2;--shadow:rgba(80,40,5,.1);--green:#1A7A3A;--red:#C0392B;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans',sans-serif;min-height:100vh;}
.nav-bar{display:flex;justify-content:space-between;align-items:center;background:var(--brown);padding:9px 14px;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.3);}
.nav-logo{font-family:'Playfair Display',serif;font-size:16px;color:#E8C878;font-weight:700;}
.nav-links{display:flex;gap:4px;}
.nav-link{color:rgba(255,255,255,.65);font-size:11px;padding:5px 10px;border-radius:14px;text-decoration:none;border:1px solid transparent;transition:all .2s;}
.nav-link.active,.nav-link:hover{background:rgba(255,255,255,.15);color:#fff;border-color:rgba(255,255,255,.2);}
.lang-bar{background:var(--brown2);padding:7px 12px;display:flex;gap:5px;overflow-x:auto;scrollbar-width:none;}
.lang-bar::-webkit-scrollbar{display:none;}
.lang-btn{flex-shrink:0;padding:5px 11px;border-radius:15px;border:1.5px solid rgba(255,255,255,.25);background:transparent;color:#EDD9B0;font-size:11px;font-weight:500;font-family:inherit;cursor:pointer;transition:all .2s;white-space:nowrap;}
.lang-btn.active{background:var(--gold-mid);border-color:var(--gold-mid);color:#fff;font-weight:700;}
.header{background:linear-gradient(160deg,#2E1508,#5C3010);padding:16px 20px 28px;text-align:center;position:relative;overflow:hidden;}
.header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:18px;background:var(--bg);border-radius:18px 18px 0 0;}
.logo-row{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:4px;}
.logo-icon{width:38px;height:38px;background:var(--gold-mid);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;}
.logo-name{font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:#fff;}
.logo-name span{color:#E8C878;}
.logo-tag{font-size:11px;color:rgba(255,255,255,.6);font-style:italic;margin-bottom:10px;}
.hdr-title{font-family:'Playfair Display',serif;font-style:italic;font-size:clamp(18px,5vw,26px);color:#EDD9A0;}
.cat-tabs{position:sticky;top:79px;z-index:90;background:var(--bg);display:flex;overflow-x:auto;scrollbar-width:none;border-bottom:2px solid var(--border);box-shadow:0 2px 5px var(--shadow);}
.cat-tabs::-webkit-scrollbar{display:none;}
.cat-tab{flex-shrink:0;padding:10px 14px;font-size:12px;font-weight:600;color:var(--text3);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;}
.cat-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.content{padding-bottom:80px;}
.cat-section{display:none;animation:fadeIn .25s ease;}
.cat-section.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.sec-hdr{background:linear-gradient(135deg,var(--brown2),#8B5020);padding:14px 20px;text-align:center;margin-bottom:12px;}
.sec-title{font-family:'Playfair Display',serif;font-size:clamp(16px,4vw,20px);color:#fff;font-weight:700;}
.sec-note{margin-top:3px;font-size:11px;color:rgba(255,255,255,.82);}
.menu-items{padding:0 12px;}
.menu-item{background:var(--card);border:1.5px solid var(--border);border-radius:11px;padding:13px 14px;margin-bottom:9px;box-shadow:0 2px 6px var(--shadow);cursor:pointer;transition:all .2s;position:relative;}
.menu-item:active{transform:scale(.99);background:var(--card2);}
.menu-item::after{content:'‚ñ∂';position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--gold-mid);opacity:.5;}
.item-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding-right:16px;}
.item-name{font-size:14px;font-weight:700;color:var(--brown);line-height:1.35;}
.item-name-vi{font-size:11px;color:var(--text3);margin-top:2px;font-style:italic;}
.item-prices{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;}
.price-row{display:flex;align-items:center;gap:5px;}
.price-dur{font-size:10px;font-weight:600;color:var(--text3);background:var(--bg2);border:1px solid var(--border);padding:2px 6px;border-radius:9px;}
.price-amt{font-size:15px;font-weight:800;color:var(--gold);}
.item-desc{font-size:11.5px;color:var(--text3);line-height:1.55;border-top:1px solid var(--bg2);padding-top:6px;margin-top:5px;}
.skin-item{background:var(--card);border:1.5px solid var(--border);border-radius:10px;margin:0 12px 8px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;cursor:pointer;box-shadow:0 1px 5px var(--shadow);position:relative;}
.skin-item::after{content:'‚ñ∂';position:absolute;right:12px;font-size:10px;color:var(--gold-mid);opacity:.5;}
.skin-name{font-size:13.5px;font-weight:700;color:var(--brown);flex:1;padding-right:14px;}
.skin-name-vi{font-size:10.5px;color:var(--text3);font-style:italic;margin-top:2px;}
.skin-price{font-size:14px;font-weight:800;color:var(--gold);white-space:nowrap;}
.table-wrap{padding:0 12px 8px;overflow-x:auto;}
.menu-table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden;box-shadow:0 2px 7px var(--shadow);}
.menu-table thead tr{background:var(--brown2);}
.menu-table th{padding:10px 8px;font-size:12px;font-weight:700;color:#fff;text-align:center;}
.menu-table th:first-child{text-align:left;padding-left:12px;}
.menu-table td{padding:9px 8px;font-size:13px;color:var(--text);text-align:center;border-bottom:1px solid var(--bg2);background:var(--card);cursor:pointer;}
.menu-table td:first-child{text-align:left;color:var(--brown);font-weight:700;background:var(--card2);padding-left:12px;}
.menu-table tr:nth-child(even) td{background:var(--bg2);}
.menu-table tr:nth-child(even) td:first-child{background:#EDE0C8;}
.td-name-vi{font-size:10px;color:var(--text3);font-style:italic;display:block;margin-top:2px;font-weight:400;}
.p-cell{color:var(--gold);font-weight:800;}
.promo-box{margin:8px 12px 4px;background:linear-gradient(135deg,#3E2310,#7A3C10);border-radius:12px;padding:14px;text-align:center;}
.promo-title{font-size:12px;font-weight:700;color:#EDD9A0;letter-spacing:1px;margin-bottom:10px;}
.promo-deals{display:flex;gap:8px;justify-content:center;}
.promo-deal{background:var(--gold-mid);color:#fff;border-radius:9px;padding:8px 18px;font-weight:800;font-size:13.5px;}
/* Loading */
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;}
.loading-logo{font-family:'Playfair Display',serif;font-size:28px;color:var(--brown);margin-bottom:16px;}
.loading-logo span{color:var(--gold-mid);}
.loading-spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--gold-mid);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:12px;color:var(--text3);font-size:13px;}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:500;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:#fff;border-radius:22px 22px 0 0;padding:22px 18px 30px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;animation:slideUp .28s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-drag{width:40px;height:4px;background:#ddd;border-radius:4px;margin:0 auto 16px;}
.modal-title{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--brown);margin-bottom:3px;}
.modal-sub{font-size:12px;color:var(--text3);margin-bottom:14px;}
.info-box{background:var(--card2);border:1.5px solid var(--border);border-radius:10px;padding:12px;margin-bottom:14px;}
.info-menu-name{font-size:14.5px;font-weight:700;color:var(--brown);}
.info-menu-vi{font-size:11px;color:var(--text3);font-style:italic;margin-bottom:8px;}
.price-opts{display:flex;gap:8px;flex-wrap:wrap;}
.price-opt{padding:7px 14px;border-radius:18px;border:2px solid var(--border);background:var(--bg2);color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;}
.price-opt.selected,.price-opt:hover{background:var(--gold);border-color:var(--gold);color:#fff;}
.field-lbl{font-size:12px;font-weight:700;color:var(--text2);margin:12px 0 5px;}
.field-sel,.field-txt{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;font-size:14px;font-family:inherit;background:var(--card);color:var(--text);}
.field-sel:focus,.field-txt:focus{outline:none;border-color:var(--gold);}
.therapist-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.thr-btn{padding:10px 6px;border-radius:9px;border:2px solid var(--border);background:var(--bg2);color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;text-align:center;transition:all .15s;line-height:1.3;}
.thr-btn.selected{background:var(--green);border-color:var(--green);color:#fff;}
.thr-btn.busy{opacity:.4;cursor:not-allowed;}
.btn-start{width:100%;padding:15px;border-radius:12px;background:var(--green);color:#fff;font-size:16px;font-weight:700;border:none;cursor:pointer;margin-top:14px;box-shadow:0 4px 12px rgba(26,122,58,.3);}
.btn-start:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;}
.btn-dismiss{width:100%;padding:11px;border-radius:12px;background:transparent;color:var(--text3);font-size:14px;font-weight:600;border:1.5px solid var(--border);cursor:pointer;margin-top:8px;}
</style>
</head>
<body>

<!-- Loading screen -->
<div class="loading-screen" id="loadingScreen">
  <img id="loadingLogo" src="" style="height:65px;margin-bottom:10px;object-fit:contain;" alt="Lavie Spa">
  <div class="loading-spinner"></div>
  <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
</div>

<div id="appBody" style="display:none">
<div class="nav-bar">
  <img id="navLogo" src="" style="height:28px;object-fit:contain;vertical-align:middle;display:block;" alt="Lavie Spa">
  <div class="nav-links">
    <a class="nav-link active" href="index.html">üìã Menu</a>
    <a class="nav-link" href="admin.html">‚öôÔ∏è Qu·∫£n l√Ω</a>
    <a class="nav-link" href="settings.html">üõ† C√†i ƒë·∫∑t</a>
  </div>
</div>
<div class="lang-bar">
  <button class="lang-btn active" onclick="setLang('vi')" data-lang="vi">üáªüá≥ Vi·ªát</button>
  <button class="lang-btn" onclick="setLang('ko')" data-lang="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</button>
  <button class="lang-btn" onclick="setLang('en')" data-lang="en">üá¨üáß English</button>
  <button class="lang-btn" onclick="setLang('ja')" data-lang="ja">üáØüáµ Êó•Êú¨Ë™û</button>
  <button class="lang-btn" onclick="setLang('zh')" data-lang="zh">üá®üá≥ ‰∏≠Êñá</button>
  <button class="lang-btn" onclick="setLang('th')" data-lang="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
  <button class="lang-btn" onclick="setLang('ms')" data-lang="ms">üá≤üáæ Melayu</button>
  <button class="lang-btn" onclick="setLang('ru')" data-lang="ru">üá∑üá∫ –†—É—Å</button>
</div>
<div class="header">
  <div style="display:flex;justify-content:center;align-items:center;padding:8px 0 4px;">
    <img id="headerLogo" src="" style="max-height:88px;max-width:310px;width:100%;object-fit:contain;display:block;margin:0 auto;" alt="Lavie Spa">
  </div>
  <div class="hdr-title" id="hdrTitle">B·∫£ng Gi√° D·ªãch V·ª•</div>
</div>
<div class="cat-tabs" id="catTabs"></div>
<div class="content" id="content"></div>
</div><!-- /appBody -->

<!-- Session Modal -->
<div class="modal-overlay" id="sessionModal" onclick="if(event.target===this)closeModal()">
  <div class="modal-sheet">
    <div class="modal-drag"></div>
    <div class="modal-title">üåø B·∫Øt ƒë·∫ßu d·ªãch v·ª•</div>
    <div class="modal-sub">Ch·ªçn m·ª©c gi√°, gi∆∞·ªùng v√† k·ªπ thu·∫≠t vi√™n</div>
    <div class="info-box">
      <div class="info-menu-name" id="mMenuName"></div>
      <div class="info-menu-vi" id="mMenuVi"></div>
      <div class="price-opts" id="mPriceOpts"></div>
    </div>
    <div class="field-lbl">üõè Gi∆∞·ªùng</div>
    <select class="field-sel" id="mBedSel"></select>
    <div class="field-lbl">üë§ K·ªπ thu·∫≠t vi√™n</div>
    <div class="therapist-grid" id="mThrGrid"></div>
    <div class="field-lbl">üìù Ghi ch√∫ (tu·ª≥ ch·ªçn)</div>
    <input class="field-txt" id="mNote" type="text" placeholder="VD: kh√°ch VIP, y√™u c·∫ßu ƒë·∫∑c bi·ªát...">
    <button class="btn-start" id="mBtnStart" disabled onclick="doStartSession()">‚ñ∂ B·∫Øt ƒë·∫ßu ngay</button>
    <button class="btn-dismiss" onclick="closeModal()">‚úï ƒê√≥ng</button>
  </div>
</div>

<script type="module">
import { initializeApp }         from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot, query, orderBy }
  from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const app = initializeApp(DB.FIREBASE_CONFIG);
const fs  = getFirestore(app);

// ‚îÄ‚îÄ In-memory cache ‚îÄ‚îÄ
let appData = { categories:[], menus:[], therapists:[], beds:[], sessions:[] };

// Set logos as soon as db.js is loaded
function setLogos() {
  const src = DB.LAVIE_LOGO_B64;
  if (!src) return;
  ['loadingLogo','navLogo','headerLogo'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.src = src;
  });
}
let appLang = 'vi';
let currentCat = null;
let selMenuId=null, selPriceIdx=null, selThrId=null;

setLogos();
const TITLES={vi:'B·∫£ng Gi√° D·ªãch V·ª•',ko:'ÏÑúÎπÑÏä§ Í∞ÄÍ≤©Ìëú',en:'Service Price List',ja:'„Çµ„Éº„Éì„ÇπÊñôÈáëË°®',zh:'ÊúçÂä°‰ª∑ÁõÆË°®',th:'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',ms:'Senarai Harga',ru:'–ü—Ä–∞–π—Å-–ª–∏—Å—Ç'};
const MIN_L={vi:'ph√∫t',ko:'Î∂Ñ',en:'min',ja:'ÂàÜ',zh:'ÂàÜÈíü',th:'‡∏ô‡∏≤‡∏ó‡∏µ',ms:'minit',ru:'–º–∏–Ω'};
const NOTE_MALE={vi:'‚òÖ Kh√°ch nam ph·ª• thu th√™m 50k/ng∆∞·ªùi',ko:'‚òÖ ÎÇ®ÏÑ± Í≥†Í∞ù 50k Ï∂îÍ∞Ä',en:'‚òÖ Male guests: +50k',ja:'‚òÖ Áî∑ÊÄß„ÅäÂÆ¢Êßò +50k',zh:'‚òÖ Áî∑ÊÄßÈ°æÂÆ¢È¢ùÂ§ñ50k',th:'‚òÖ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≤‡∏¢ +50k',ms:'‚òÖ Pelanggan lelaki +50k',ru:'‚òÖ –ú—É–∂—á–∏–Ω—ã +50k'};

// ‚îÄ‚îÄ Load all data from Firestore, initializing defaults if needed ‚îÄ‚îÄ
async function loadAll() {
  // Config doc (categories, menus, beds)
  const configRef = doc(fs, 'config', 'main');
  let configSnap  = await getDoc(configRef);

  // ‚îÄ‚îÄ Î≤àÏó≠ Î≤ÑÏ†Ñ Í¥ÄÎ¶¨: db.jsÍ∞Ä Î∞îÎÄåÎ©¥ ÏûêÎèôÏúºÎ°ú Firestore ÏóÖÎç∞Ïù¥Ìä∏ ‚îÄ‚îÄ
  const TRANS_VERSION = 'v6_desc'; // Î≤ÑÏ†Ñ Î∞îÍæ∏Î©¥ Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏
  const needsSeed = !configSnap.exists();
  let needsReseed = needsSeed;

  if (!needsSeed) {
    const cfg0 = configSnap.data();
    // Î≤ÑÏ†Ñ Ï≤¥ÌÅ¨: _desc Î≤àÏó≠Ïù¥ ÏóÜÍ±∞ÎÇò Î≤ÑÏ†ÑÏù¥ Îã§Î•¥Î©¥ ÏóÖÎç∞Ïù¥Ìä∏
    const firstMenu = (cfg0.menus || [])[0];
    const hasDesc = firstMenu?.translations && 
                    Object.keys(firstMenu.translations).some(k => k.endsWith('_desc'));
    const hasVersion = cfg0._transVersion === TRANS_VERSION;
    if (!hasDesc || !hasVersion) needsReseed = true;
  }

  if (needsReseed) {
    // FirestoreÏóê Ï†ÄÏû•Îêú menusÏôÄ DEFAULT_DATAÎ•º Î≥ëÌï©
    // Í∞ÄÍ≤©, active ÏÉÅÌÉú Îì± Ïö¥ÏòÅÏûêÍ∞Ä ÏàòÏ†ïÌïú Í∞íÏùÄ Î≥¥Ï°¥ÌïòÍ≥† Î≤àÏó≠Îßå ÏóÖÎç∞Ïù¥Ìä∏
    let mergedMenus = DB.DEFAULT_DATA.menus;
    let mergedCats  = DB.DEFAULT_DATA.categories;
    let mergedBeds  = DB.DEFAULT_DATA.beds;

    if (!needsSeed) {
      const existingData = configSnap.data();
      const existingMenuMap = {};
      (existingData.menus || []).forEach(m => { existingMenuMap[m.id] = m; });

      // Í∏∞Ï°¥ Î©îÎâ¥Ïùò Í∞ÄÍ≤©¬∑active ÏÉÅÌÉú Î≥¥Ï°¥ + DEFAULT Î≤àÏó≠ Ï†ÅÏö©
      mergedMenus = DB.DEFAULT_DATA.menus.map(def => {
        const existing = existingMenuMap[def.id];
        if (!existing) return def;
        return Object.assign({}, def, {
          prices: existing.prices || def.prices,
          active: existing.active !== undefined ? existing.active : def.active,
          // Î≤àÏó≠ÏùÄ def(ÏµúÏã†)ÏóêÏÑú Í∞ÄÏ†∏Ïò¥
          translations: def.translations
        });
      });

      // Í∏∞Ï°¥ÏóêÎßå ÏûàÎäî Ïª§Ïä§ÌÖÄ Î©îÎâ¥ Ï∂îÍ∞Ä
      (existingData.menus || []).forEach(m => {
        if (!mergedMenus.find(x => x.id === m.id)) mergedMenus.push(m);
      });

      mergedBeds = existingData.beds || DB.DEFAULT_DATA.beds;
    }

    await setDoc(configRef, {
      categories: mergedCats,
      menus:      mergedMenus,
      beds:       mergedBeds,
      _transVersion: TRANS_VERSION
    });
    configSnap = await getDoc(configRef);
  }

  const cfg = configSnap.data();
  appData.categories = cfg.categories || [];
  appData.menus      = cfg.menus      || [];
  appData.beds       = cfg.beds       || [];

  // Therapists collection
  const thrSnap = await getDocs(collection(fs, 'therapists'));
  if (thrSnap.empty) {
    // Seed therapists
    for (const t of DB.DEFAULT_DATA.therapists) {
      await setDoc(doc(fs,'therapists',t.id), t);
    }
    const thrSnap2 = await getDocs(collection(fs,'therapists'));
    appData.therapists = thrSnap2.docs.map(d=>d.data());
  } else {
    appData.therapists = thrSnap.docs.map(d=>d.data());
  }

  // Active sessions (real-time listener) - with error handling
  try {
    onSnapshot(collection(fs,'sessions'), 
      snap => { appData.sessions = snap.docs.map(d=>d.data()).filter(s=>s.status==='active'); },
      err => { console.warn('Session listener error:', err); }
    );
  } catch(e) { console.warn('onSnapshot setup error:', e); }

  currentCat = appData.categories[0]?.id || null;
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('appBody').style.display = 'block';
  renderAll();
}

// ‚îÄ‚îÄ Expose setLang and openModal globally for onclick handlers ‚îÄ‚îÄ
window.setLang = function(l) {
  appLang = l;
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.dataset.lang===l));
  renderAll();
  if(currentCat) selectCat(currentCat);
};
window.selectCat = selectCat;
window.openModal = openModal;
window.closeModal = closeModal;
window.selPrice = selPrice;
window.selThr = selThr;
window.doStartSession = doStartSession;

function tName(item){
  if(!item) return '';
  if(appLang==='vi') return item.nameVi||'';
  return (item.translations&&item.translations[appLang])||item.nameVi||'';
}
function tDesc(item){
  if(!item) return '';
  if(appLang==='vi') return item.descVi||'';
  // Try translated desc, then fall back to Vi desc
  const translated = item.translations&&item.translations[appLang+'_desc'];
  if(translated && translated.trim()) return translated;
  return item.descVi||''; // show Vietnamese as fallback
}
function fmtMin(d){ return d?(d+' '+(MIN_L[appLang]||'min')):''; }
function showVi(item){ return appLang!=='vi'&&item.nameVi; }
function esc(s){ return DB.escHtml(s); }

function renderAll(){
  document.getElementById('hdrTitle').textContent = TITLES[appLang]||TITLES.vi;
  renderTabs();
  renderContent();
}

function renderTabs(){
  document.getElementById('catTabs').innerHTML = appData.categories.map(c=>
    `<div class="cat-tab ${c.id===currentCat?'active':''}" onclick="selectCat('${c.id}')">${c.icon||''} ${tName(c)}</div>`
  ).join('');
}

function renderContent(){
  const activeMenus = appData.menus.filter(m=>m.active);
  document.getElementById('content').innerHTML = appData.categories.map(cat=>{
    const cms = activeMenus.filter(m=>m.catId===cat.id);
    let h = `<div class="cat-section ${cat.id===currentCat?'active':''}" id="sec-${cat.id}">`;
    h += `<div class="sec-hdr"><div class="sec-title">${cat.icon||''} ${tName(cat)}</div>`;
    if(cms.some(m=>m.maleExtra)) h += `<div class="sec-note">${NOTE_MALE[appLang]||NOTE_MALE.vi}</div>`;
    h += `</div>`;
    if(!cms.length){h+=`<div style="text-align:center;padding:30px;color:#999;font-size:13px">Ch∆∞a c√≥ d·ªãch v·ª•</div>`;h+=`</div>`;return h;}

    const isHair = cms[0].prices&&cms[0].prices[0]&&cms[0].prices[0].label;
    const isSkin = !isHair&&cms[0].prices&&cms[0].prices[0]&&!cms[0].prices[0].duration;

    if(isHair){
      h+=`<div class="table-wrap"><table class="menu-table"><thead><tr><th>V·ªã tr√≠</th><th>LT (10 bu·ªïi)</th><th>Tr·ªçn ƒë·ªùi</th></tr></thead><tbody>`;
      cms.forEach(m=>{
        h+=`<tr onclick="openModal('${m.id}')"><td>${esc(tName(m))}${showVi(m)?`<span class="td-name-vi">${esc(m.nameVi)}</span>`:''}</td><td class="p-cell">${DB.fmtMoney(m.prices[0]?.amount)}</td><td class="p-cell">${DB.fmtMoney(m.prices[1]?.amount)}</td></tr>`;
      });
      h+=`</tbody></table></div>`;
    } else if(isSkin){
      cms.forEach(m=>{
        const ps=m.prices.map(p=>DB.fmtMoney(p.amount)).filter(Boolean).join(' - ');
        h+=`<div class="skin-item" onclick="openModal('${m.id}')"><div><div class="skin-name">${esc(tName(m))}</div>${showVi(m)?`<div class="skin-name-vi">${esc(m.nameVi)}</div>`:''}</div><div class="skin-price">${ps}</div></div>`;
      });
    } else {
      h+=`<div class="menu-items">`;
      let hasPromo=false;
      cms.forEach(m=>{
        if(m.promo) hasPromo=true;
        const ps=m.prices.map(p=>`<div class="price-row">${p.duration?`<span class="price-dur">${fmtMin(p.duration)}</span>`:''}<span class="price-amt">${DB.fmtMoney(p.amount)}</span></div>`).join('');
        const desc=tDesc(m);
        h+=`<div class="menu-item" onclick="openModal('${m.id}')">
          <div class="item-top"><div><div class="item-name">${esc(tName(m))}</div>${showVi(m)?`<div class="item-name-vi">${esc(m.nameVi)}</div>`:''}</div>
          <div class="item-prices">${ps}</div></div>
          ${desc?`<div class="item-desc">${esc(desc)}</div>`:''}
        </div>`;
      });
      h+=`</div>`;
      if(hasPromo) h+=`<div class="promo-box"><div class="promo-title">‚ú¶ Khi mua li·ªáu tr√¨nh ‚ú¶</div><div class="promo-deals"><div class="promo-deal">Mua 5 t·∫∑ng 1</div><div class="promo-deal">Mua 10 t·∫∑ng 2</div></div></div>`;
    }
    h+=`</div>`;
    return h;
  }).join('');
}

function selectCat(id){
  currentCat=id;
  document.querySelectorAll('.cat-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.cat-section').forEach(s=>s.classList.remove('active'));
  const tab = Array.from(document.querySelectorAll('.cat-tab')).find(t=>t.onclick&&t.getAttribute('onclick')===`selectCat('${id}')`);
  renderTabs();
  document.getElementById('sec-'+id)?.classList.add('active');
  document.querySelector('.cat-tab.active')?.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
function openModal(menuId){
  const menu = appData.menus.find(m=>m.id===menuId);
  if(!menu) return;
  selMenuId=menuId; selPriceIdx=null; selThrId=null;
  document.getElementById('mMenuName').textContent=tName(menu);
  document.getElementById('mMenuVi').textContent=appLang!=='vi'?menu.nameVi:'';
  document.getElementById('mPriceOpts').innerHTML=menu.prices.map((p,i)=>{
    const lbl=p.label?(p.label+' '+DB.fmtMoney(p.amount)):(p.duration?fmtMin(p.duration)+' ':'') +DB.fmtMoney(p.amount);
    return `<div class="price-opt" data-idx="${i}" onclick="selPrice(${i})">${lbl}</div>`;
  }).join('');
  if(menu.prices.length===1){selPriceIdx=0;document.querySelector('#mPriceOpts .price-opt')?.classList.add('selected');}
  const busyBeds=(appData.sessions||[]).filter(s=>s.status==='active').map(s=>s.bedId);
  const busyThrs=(appData.sessions||[]).filter(s=>s.status==='active').map(s=>s.therapistId);
  document.getElementById('mBedSel').innerHTML='<option value="">-- Kh√¥ng ch·ªçn gi∆∞·ªùng --</option>'+
    (appData.beds||[]).map(b=>`<option value="${b.id}"${busyBeds.includes(b.id)?' disabled':''} >${esc(b.name)}${busyBeds.includes(b.id)?' (ƒëang d√πng)':''}</option>`).join('');
  const activeThrs=(appData.therapists||[]).filter(t=>t.active!==false);
  document.getElementById('mThrGrid').innerHTML=activeThrs.length===0
    ?`<p style="color:#999;font-size:13px;grid-column:span 3">Ch∆∞a c√≥ k·ªπ thu·∫≠t vi√™n. <a href="settings.html">Th√™m ngay</a></p>`
    :activeThrs.map(t=>`<div class="thr-btn${busyThrs.includes(t.id)?' busy':''}" id="thr_${t.id}"${busyThrs.includes(t.id)?'':` onclick="selThr('${t.id}')"`}>${esc(t.name)}${busyThrs.includes(t.id)?'<br><small style="font-size:9px">ƒêang b·∫≠n</small>':''}</div>`).join('');
  document.getElementById('mNote').value='';
  document.getElementById('mBtnStart').disabled=true;
  document.getElementById('sessionModal').classList.add('show');
}
function closeModal(){document.getElementById('sessionModal').classList.remove('show');}
function selPrice(idx){
  selPriceIdx=idx;
  document.querySelectorAll('#mPriceOpts .price-opt').forEach((el,i)=>el.classList.toggle('selected',i===idx));
  checkReady();
}
function selThr(id){
  selThrId=id;
  document.querySelectorAll('.thr-btn').forEach(el=>el.classList.remove('selected'));
  document.getElementById('thr_'+id)?.classList.add('selected');
  checkReady();
}
function checkReady(){ document.getElementById('mBtnStart').disabled=!(selPriceIdx!==null&&selThrId); }

async function doStartSession(){
  if(!selMenuId||selPriceIdx===null||!selThrId) return;
  const menu=appData.menus.find(m=>m.id===selMenuId);
  const price=menu.prices[selPriceIdx];
  const thr=appData.therapists.find(t=>t.id===selThrId);
  const bedId=document.getElementById('mBedSel').value;
  const bed=appData.beds.find(b=>b.id===bedId);
  const note=document.getElementById('mNote').value.trim();
  const now=Date.now();
  const dur=parseInt(price.duration)||0;
  const cat=appData.categories.find(c=>c.id===menu.catId);
  const session={
    id:DB.genId('s'),menuId:menu.id,menuNameVi:menu.nameVi,
    catId:menu.catId,catNameVi:cat?cat.nameVi:'',
    therapistId:selThrId,therapistName:thr?thr.name:'',
    bedId:bedId||null,bedName:bed?bed.name:'',
    priceIdx:selPriceIdx,priceLabel:price.label||(price.duration?price.duration+' ph√∫t':''),
    amount:price.amount||0,duration:dur,
    startTime:now,endTime:dur>0?now+dur*60000:null,
    note:note,status:'active'
  };
  await setDoc(doc(fs,'sessions',session.id),session);
  closeModal();
  alert(`‚úÖ ƒê√£ b·∫Øt ƒë·∫ßu!\n${session.menuNameVi}\nK·ªπ thu·∫≠t vi√™n: ${session.therapistName}${session.bedName?' | '+session.bedName:''}${session.endTime?'\nK·∫øt th√∫c: '+DB.fmtTime(session.endTime):''}`);
  window.location.href='admin.html';
}

// Retry logic for Firestore loading
let loadRetries = 0;
async function loadWithRetry() {
  try {
    await loadAll();
  } catch(e) {
    loadRetries++;
    console.error('Load error (attempt ' + loadRetries + '):', e);
    if (loadRetries < 3) {
      document.querySelector('.loading-text').textContent = 'ƒêang th·ª≠ l·∫°i... (' + loadRetries + '/3)';
      setTimeout(loadWithRetry, 2000);
    } else {
      document.querySelector('.loading-text').textContent = 'L·ªói k·∫øt n·ªëi. Vui l√≤ng t·∫£i l·∫°i trang.';
      document.querySelector('.loading-text').style.color = '#C0392B';
    }
  }
}
loadWithRetry();
</script>
</body>
</html>
