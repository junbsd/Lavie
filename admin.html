<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lavie Spa - Qu·∫£n L√Ω</title>
<script src="db.js"></script>
<style>
:root{
  --bg:#F5F7FA;--card:#fff;--border:#E2E8F0;--brown:#3E2310;--brown2:#5C3A1A;
  --gold:#96621A;--gold-mid:#B87D2E;--green:#16A34A;--green-light:#DCFCE7;
  --red:#DC2626;--red-light:#FEE2E2;--blue:#2563EB;--blue-light:#DBEAFE;
  --yellow:#D97706;--yellow-light:#FEF3C7;--text:#1E293B;--text2:#475569;--text3:#94A3B8;
  --shadow:rgba(0,0,0,0.06);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans','Segoe UI',sans-serif;min-height:100vh;}

.topbar{background:var(--brown);padding:11px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.topbar-logo{font-size:15px;font-weight:700;color:#E8C878;}
.topbar-nav{display:flex;gap:4px;}
.tnav{color:rgba(255,255,255,0.65);font-size:11px;padding:5px 10px;border-radius:12px;text-decoration:none;border:1px solid transparent;}
.tnav:hover,.tnav.active{background:rgba(255,255,255,0.15);color:#fff;}

.page-tabs{background:#fff;border-bottom:2px solid var(--border);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 4px;}
.page-tabs::-webkit-scrollbar{display:none;}
.ptab{flex-shrink:0;padding:12px 18px;font-size:13px;font-weight:600;color:var(--text2);cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;transition:all 0.2s;}
.ptab.active{color:var(--gold);border-bottom-color:var(--gold);}

.page-content{padding:14px;max-width:600px;margin:0 auto;display:none;}
.page-content.active{display:block;}

.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px var(--shadow);border:1px solid var(--border);}
.card-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}

/* SESSION CARD */
.session-card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 8px var(--shadow);border-left:4px solid var(--green);position:relative;}
.session-card.finishing{border-left-color:var(--yellow);}
.session-card.overtime{border-left-color:var(--red);}
.sc-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px;}
.sc-menu{font-size:14px;font-weight:700;color:var(--text);line-height:1.3;flex:1;}
.sc-amount{font-size:17px;font-weight:800;color:var(--gold);white-space:nowrap;}
.sc-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;}
.badge{font-size:11px;padding:3px 9px;border-radius:8px;font-weight:600;}
.badge-green{background:var(--green-light);color:var(--green);}
.badge-blue{background:var(--blue-light);color:var(--blue);}
.badge-yellow{background:var(--yellow-light);color:var(--yellow);}
.badge-red{background:var(--red-light);color:var(--red);}
.sc-timer{font-size:28px;font-weight:800;color:var(--green);font-variant-numeric:tabular-nums;letter-spacing:-1px;margin:4px 0;}
.sc-timer.finishing{color:var(--yellow);}
.sc-timer.overtime{color:var(--red);}
.sc-note{font-size:12px;color:var(--text2);margin-top:6px;padding:6px 10px;background:var(--bg);border-radius:8px;border-left:3px solid var(--border);}
.sc-actions{display:flex;gap:8px;margin-top:10px;}
.btn-sm{padding:8px;border-radius:8px;border:none;font-size:12px;font-weight:700;cursor:pointer;flex:1;transition:all 0.15s;}
.btn-complete{background:var(--green);color:#fff;}
.btn-note-edit{background:var(--blue-light);color:var(--blue);border:1px solid var(--blue);}
.btn-cancel-sess{background:var(--red-light);color:var(--red);border:1px solid var(--red);}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px;}
.stat-box{background:var(--card);border-radius:11px;padding:12px 10px;box-shadow:0 2px 6px var(--shadow);text-align:center;border:1px solid var(--border);}
.stat-num{font-size:22px;font-weight:800;color:var(--gold);line-height:1.2;}
.stat-lbl{font-size:11px;color:var(--text3);margin-top:3px;}

/* FILTER */
.filter-row{display:flex;gap:7px;margin-bottom:12px;flex-wrap:wrap;}
.filter-btn{padding:6px 13px;border-radius:16px;border:1.5px solid var(--border);background:var(--card);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.filter-btn.active{background:var(--gold);border-color:var(--gold);color:#fff;}

/* RECORD ITEM */
.rec-item{background:var(--card);border-radius:10px;padding:11px 13px;margin-bottom:7px;box-shadow:0 1px 4px var(--shadow);border:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.rec-info{flex:1;}
.rec-menu{font-size:13px;font-weight:700;color:var(--text);}
.rec-meta{font-size:11px;color:var(--text2);margin-top:2px;line-height:1.5;}
.rec-note{font-size:11px;color:var(--blue);margin-top:4px;padding:4px 7px;background:var(--blue-light);border-radius:5px;font-style:italic;}
.rec-amount{font-size:15px;font-weight:800;color:var(--gold);white-space:nowrap;}

/* CHART */
.chart-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.chart-lbl{font-size:11.5px;color:var(--text2);width:110px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;}
.chart-bar-bg{flex:1;background:var(--border);border-radius:4px;height:18px;overflow:hidden;}
.chart-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold-mid),var(--gold));border-radius:4px;transition:width 0.5s ease;min-width:2px;}
.chart-val{font-size:11px;font-weight:700;color:var(--gold);width:80px;flex-shrink:0;}

/* SECTION HDR */
.sec-hdr-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.sec-hdr-title{font-size:15px;font-weight:700;color:var(--text);}
.btn-add-link{padding:7px 13px;border-radius:8px;background:var(--gold);color:#fff;border:none;font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block;}

/* EMPTY */
.empty-state{text-align:center;padding:40px 20px;color:var(--text3);}
.empty-ico{font-size:48px;margin-bottom:12px;}
.empty-txt{font-size:14px;line-height:1.6;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.show{display:flex;}
.modal-box{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:360px;animation:popIn 0.2s ease;}
@keyframes popIn{from{opacity:0;transform:scale(0.93)}to{opacity:1;transform:scale(1)}}
.modal-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:12px;}
.field-lbl{font-size:12px;font-weight:600;color:var(--text2);margin:10px 0 4px;}
.field-input{width:100%;padding:10px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;color:var(--text);background:#fff;}
.field-input:focus{outline:none;border-color:var(--gold);}
.modal-btn-row{display:flex;gap:8px;margin-top:14px;}
.btn-primary{flex:1;padding:11px;border-radius:9px;background:var(--gold);color:#fff;font-size:14px;font-weight:700;border:none;cursor:pointer;}
.btn-secondary{flex:1;padding:11px;border-radius:9px;background:var(--bg);color:var(--text2);font-size:14px;font-weight:600;border:1.5px solid var(--border);cursor:pointer;}

.export-btn{padding:7px 13px;border-radius:8px;background:var(--blue-light);color:var(--blue);border:1px solid var(--blue);font-size:12px;font-weight:600;cursor:pointer;}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-logo">üåø Lavie Spa - Qu·∫£n L√Ω</div>
  <div class="topbar-nav">
    <a class="tnav" href="index.html">üìã Menu</a>
    <a class="tnav active" href="admin.html">‚öôÔ∏è Qu·∫£n l√Ω</a>
    <a class="tnav" href="settings.html">üõ† C√†i ƒë·∫∑t</a>
  </div>
</div>

<div class="page-tabs">
  <div class="ptab active" onclick="showPage('live')">üü¢ ƒêang th·ª±c hi·ªán</div>
  <div class="ptab" onclick="showPage('records')">üìã L·ªãch s·ª≠</div>
  <div class="ptab" onclick="showPage('stats')">üìä Th·ªëng k√™</div>
</div>

<!-- LIVE -->
<div id="page-live" class="page-content active">
  <div class="sec-hdr-row">
    <div class="sec-hdr-title">D·ªãch v·ª• ƒëang ch·∫°y</div>
    <a class="btn-add-link" href="index.html">+ Th√™m d·ªãch v·ª•</a>
  </div>
  <div id="liveList"></div>
</div>

<!-- RECORDS -->
<div id="page-records" class="page-content">
  <div class="sec-hdr-row">
    <div class="sec-hdr-title">L·ªãch s·ª≠ d·ªãch v·ª•</div>
    <button class="export-btn" onclick="exportRecords()">üì• Xu·∫•t Excel</button>
  </div>
  <div class="filter-row">
    <button class="filter-btn active" onclick="setRecFilter('day',this)">H√¥m nay</button>
    <button class="filter-btn" onclick="setRecFilter('week',this)">Tu·∫ßn n√†y</button>
    <button class="filter-btn" onclick="setRecFilter('month',this)">Th√°ng n√†y</button>
    <button class="filter-btn" onclick="setRecFilter('year',this)">NƒÉm n√†y</button>
    <button class="filter-btn" onclick="setRecFilter('all',this)">T·∫•t c·∫£</button>
  </div>
  <div id="recSummary"></div>
  <div id="recList"></div>
</div>

<!-- STATS -->
<div id="page-stats" class="page-content">
  <div class="filter-row">
    <button class="filter-btn active" onclick="setStatFilter('day',this)">H√¥m nay</button>
    <button class="filter-btn" onclick="setStatFilter('week',this)">Tu·∫ßn n√†y</button>
    <button class="filter-btn" onclick="setStatFilter('month',this)">Th√°ng n√†y</button>
    <button class="filter-btn" onclick="setStatFilter('year',this)">NƒÉm n√†y</button>
    <button class="filter-btn" onclick="setStatFilter('all',this)">T·∫•t c·∫£</button>
  </div>
  <div id="statsContent"></div>
</div>

<!-- Note Modal -->
<div class="modal-overlay" id="noteModal" onclick="if(event.target===this)closeNoteModal()">
  <div class="modal-box">
    <div class="modal-title">üìù Ghi ch√∫</div>
    <div class="field-lbl">N·ªôi dung ghi ch√∫</div>
    <input class="field-input" id="noteInput" type="text" placeholder="Nh·∫≠p ghi ch√∫...">
    <div class="modal-btn-row">
      <button class="btn-secondary" onclick="closeNoteModal()">H·ªßy</button>
      <button class="btn-primary" onclick="saveNote()">L∆∞u</button>
    </div>
  </div>
</div>

<script>
var appDB;
var recFilter  = 'day';
var statFilter = 'day';
var editingSessId = null;
var timerRafId = null;

function init() {
  appDB = DB.loadDB();
  renderLive();
  startTimerLoop();
}

function showPage(name) {
  ['live','records','stats'].forEach(function(p) {
    document.getElementById('page-' + p).classList.toggle('active', p === name);
  });
  document.querySelectorAll('.ptab').forEach(function(t, i) {
    t.classList.toggle('active', ['live','records','stats'][i] === name);
  });
  if (name === 'records') renderRecords();
  if (name === 'stats')   renderStats();
}

// ‚îÄ‚îÄ LIVE ‚îÄ‚îÄ
function renderLive() {
  appDB = DB.loadDB();
  var sessions = (appDB.sessions || []).filter(function(s) { return s.status === 'active'; });
  var el = document.getElementById('liveList');

  if (sessions.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-ico">üõèÔ∏è</div>' +
      '<div class="empty-txt">Ch∆∞a c√≥ d·ªãch v·ª• n√†o ƒëang th·ª±c hi·ªán.<br>' +
      'V√†o <a href="index.html" style="color:var(--gold)">B·∫£ng gi√°</a> ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div></div>';
    return;
  }

  el.innerHTML = sessions.map(function(s) {
    var cardClass = '';
    if (s.endTime) {
      var rem = s.endTime - Date.now();
      if (rem < 0) cardClass = 'overtime';
      else if (rem < 300000) cardClass = 'finishing';
    }
    return '<div class="session-card ' + cardClass + '" id="sc_' + s.id + '">' +
      '<div class="sc-top">' +
        '<div class="sc-menu">' + escHtml(s.menuNameVi) + '</div>' +
        '<div class="sc-amount">' + DB.fmtMoney(s.amount) + '</div>' +
      '</div>' +
      '<div class="sc-meta">' +
        '<span class="badge badge-green">üë§ ' + escHtml(s.therapistName || '‚Äî') + '</span>' +
        (s.bedName ? '<span class="badge badge-blue">üõè ' + escHtml(s.bedName) + '</span>' : '') +
        '<span class="badge badge-yellow">üïê B·∫Øt ƒë·∫ßu: ' + DB.fmtTime(s.startTime) + '</span>' +
        (s.endTime ? '<span class="badge ' + (cardClass === 'overtime' ? 'badge-red' : 'badge-blue') +
          '">‚è∞ K·∫øt th√∫c: ' + DB.fmtTime(s.endTime) + '</span>' : '') +
      '</div>' +
      '<div class="sc-timer" id="timer_' + s.id + '">--:--</div>' +
      (s.note ? '<div class="sc-note">üìù ' + escHtml(s.note) + '</div>' : '') +
      '<div class="sc-actions">' +
        '<button class="btn-sm btn-complete" onclick="completeSession(\'' + s.id + '\')">‚úÖ Ho√†n th√†nh</button>' +
        '<button class="btn-sm btn-note-edit" onclick="openNoteModal(\'' + s.id + '\')">üìù Ghi ch√∫</button>' +
        '<button class="btn-sm btn-cancel-sess" onclick="cancelSession(\'' + s.id + '\')">‚úï H·ªßy</button>' +
      '</div></div>';
  }).join('');

  updateTimers();
}

function startTimerLoop() {
  function loop() {
    updateTimers();
    timerRafId = setTimeout(loop, 1000);
  }
  loop();
}

function updateTimers() {
  var sessions = (appDB.sessions || []).filter(function(s) { return s.status === 'active'; });
  sessions.forEach(function(s) {
    var timerEl = document.getElementById('timer_' + s.id);
    var cardEl  = document.getElementById('sc_' + s.id);
    if (!timerEl) return;
    var now = Date.now();
    var txt = '', cls = '';
    if (s.endTime) {
      var rem = s.endTime - now;
      if (rem > 0) {
        var m = Math.floor(rem / 60000);
        var sec = Math.floor((rem % 60000) / 1000);
        txt = pad(m) + ':' + pad(sec);
        cls = rem < 300000 ? 'finishing' : '';
        if (cardEl) { cardEl.className = 'session-card' + (rem < 300000 ? ' finishing' : ''); }
      } else {
        var over = Math.floor(-rem / 60000);
        txt = '+' + over + ' ph√∫t';
        cls = 'overtime';
        if (cardEl) cardEl.className = 'session-card overtime';
      }
    } else {
      var elapsed = Math.floor((now - s.startTime) / 60000);
      txt = elapsed + ' ph√∫t';
    }
    timerEl.textContent = txt;
    timerEl.className = 'sc-timer ' + cls;
  });
}

function pad(n) { return String(n).padStart(2, '0'); }
function escHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function completeSession(id) {
  if (!confirm('Ho√†n th√†nh d·ªãch v·ª• n√†y?')) return;
  appDB = DB.loadDB();
  var idx = -1;
  for (var i = 0; i < appDB.sessions.length; i++) {
    if (appDB.sessions[i].id === id) { idx = i; break; }
  }
  if (idx === -1) return;
  var s = appDB.sessions[idx];
  s.status = 'completed';
  s.completedTime = Date.now();
  if (!appDB.records) appDB.records = [];
  appDB.records.push(JSON.parse(JSON.stringify(s)));
  appDB.sessions.splice(idx, 1);
  DB.saveDB(appDB);
  renderLive();
}

function cancelSession(id) {
  if (!confirm('H·ªßy d·ªãch v·ª• n√†y? (Kh√¥ng t√≠nh doanh thu)')) return;
  appDB = DB.loadDB();
  var idx = -1;
  for (var i = 0; i < appDB.sessions.length; i++) {
    if (appDB.sessions[i].id === id) { idx = i; break; }
  }
  if (idx === -1) return;
  var s = appDB.sessions[idx];
  s.status = 'cancelled';
  s.completedTime = Date.now();
  s.amount = 0;
  if (!appDB.records) appDB.records = [];
  appDB.records.push(JSON.parse(JSON.stringify(s)));
  appDB.sessions.splice(idx, 1);
  DB.saveDB(appDB);
  renderLive();
}

function openNoteModal(id) {
  editingSessId = id;
  appDB = DB.loadDB();
  var s = (appDB.sessions || []).find(function(x) { return x.id === id; });
  document.getElementById('noteInput').value = (s && s.note) ? s.note : '';
  document.getElementById('noteModal').classList.add('show');
  setTimeout(function(){ document.getElementById('noteInput').focus(); }, 100);
}
function closeNoteModal() {
  document.getElementById('noteModal').classList.remove('show');
  editingSessId = null;
}
function saveNote() {
  if (!editingSessId) return;
  appDB = DB.loadDB();
  var s = (appDB.sessions || []).find(function(x) { return x.id === editingSessId; });
  if (s) { s.note = document.getElementById('noteInput').value.trim(); DB.saveDB(appDB); }
  closeNoteModal();
  renderLive();
}

// ‚îÄ‚îÄ RECORDS ‚îÄ‚îÄ
function getRange(filter) {
  var now = new Date();
  var from = new Date();
  if (filter === 'day')   { from.setHours(0,0,0,0); }
  else if (filter === 'week')  { from.setDate(now.getDate() - now.getDay()); from.setHours(0,0,0,0); }
  else if (filter === 'month') { from.setDate(1); from.setHours(0,0,0,0); }
  else if (filter === 'year')  { from.setMonth(0,1); from.setHours(0,0,0,0); }
  else return null;
  return { from: from.getTime(), to: Date.now() };
}

function getRecords(filter) {
  appDB = DB.loadDB();
  var all = (appDB.records || []).filter(function(r) { return r.status === 'completed'; });
  var range = getRange(filter);
  if (!range) return all;
  return all.filter(function(r) {
    var ts = r.completedTime || r.startTime;
    return ts >= range.from && ts <= range.to;
  });
}

function setRecFilter(f, btn) {
  recFilter = f;
  document.querySelectorAll('#page-records .filter-btn').forEach(function(b) { b.classList.remove('active'); });
  if (btn) btn.classList.add('active');
  renderRecords();
}

function renderRecords() {
  var recs = getRecords(recFilter).sort(function(a,b) {
    return (b.completedTime||b.startTime) - (a.completedTime||a.startTime);
  });
  var total = recs.reduce(function(s,r) { return s + (r.amount||0); }, 0);

  document.getElementById('recSummary').innerHTML =
    '<div class="stats-grid">' +
    '<div class="stat-box"><div class="stat-num">' + recs.length + '</div><div class="stat-lbl">L∆∞·ª£t d·ªãch v·ª•</div></div>' +
    '<div class="stat-box"><div class="stat-num" style="font-size:17px">' + DB.fmtMoney(total) + '</div><div class="stat-lbl">T·ªïng doanh thu</div></div>' +
    '</div>';

  if (recs.length === 0) {
    document.getElementById('recList').innerHTML =
      '<div class="empty-state"><div class="empty-ico">üìã</div><div class="empty-txt">Ch∆∞a c√≥ d·ªØ li·ªáu.</div></div>';
    return;
  }

  document.getElementById('recList').innerHTML = recs.map(function(r) {
    return '<div class="rec-item">' +
      '<div class="rec-info">' +
        '<div class="rec-menu">' + escHtml(r.menuNameVi) + '</div>' +
        '<div class="rec-meta">' +
          'üë§ ' + escHtml(r.therapistName || '‚Äî') +
          (r.bedName ? ' &nbsp;|&nbsp; üõè ' + escHtml(r.bedName) : '') +
          ' &nbsp;|&nbsp; üïê ' + DB.fmtDateTime(r.completedTime || r.startTime) +
          (r.duration ? ' &nbsp;|&nbsp; ‚è± ' + r.duration + ' ph√∫t' : '') +
        '</div>' +
        (r.note ? '<div class="rec-note">üìù ' + escHtml(r.note) + '</div>' : '') +
      '</div>' +
      '<div class="rec-amount">' + DB.fmtMoney(r.amount) + '</div>' +
      '</div>';
  }).join('');
}

function exportRecords() {
  var recs = getRecords(recFilter);
  DB.exportToCSV('laviespa_lichsu_' + new Date().toISOString().slice(0,10) + '.csv',
    ['Th·ªùi gian','D·ªãch v·ª•','K·ªπ thu·∫≠t vi√™n','Gi∆∞·ªùng','Th·ªùi l∆∞·ª£ng','Doanh thu','Ghi ch√∫'],
    recs.map(function(r) {
      return [
        DB.fmtDateTime(r.completedTime||r.startTime),
        r.menuNameVi, r.therapistName||'', r.bedName||'',
        r.duration ? r.duration+' ph√∫t' : '', r.amount||0, r.note||''
      ];
    })
  );
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function setStatFilter(f, btn) {
  statFilter = f;
  document.querySelectorAll('#page-stats .filter-btn').forEach(function(b) { b.classList.remove('active'); });
  if (btn) btn.classList.add('active');
  renderStats();
}

function renderStats() {
  appDB = DB.loadDB();
  var recs = getRecords(statFilter);
  var total = recs.reduce(function(s,r) { return s + (r.amount||0); }, 0);
  var cnt   = recs.length;

  // by therapist
  var byThr = {};
  recs.forEach(function(r) {
    var k = r.therapistName || 'Kh√¥ng r√µ';
    if (!byThr[k]) byThr[k] = {count:0, revenue:0};
    byThr[k].count++; byThr[k].revenue += r.amount||0;
  });
  // by category
  var byCat = {};
  recs.forEach(function(r) {
    var cat = (appDB.categories||[]).find(function(c){ return c.id === r.catId; });
    var k = cat ? cat.nameVi : (r.catNameVi || 'Kh√°c');
    if (!byCat[k]) byCat[k] = {count:0, revenue:0};
    byCat[k].count++; byCat[k].revenue += r.amount||0;
  });
  // by menu (top 8)
  var byMenu = {};
  recs.forEach(function(r) {
    var k = r.menuNameVi || 'Kh√°c';
    if (!byMenu[k]) byMenu[k] = {count:0, revenue:0};
    byMenu[k].count++; byMenu[k].revenue += r.amount||0;
  });

  var maxThr  = Math.max(1, ...Object.values(byThr).map(function(v){ return v.revenue; }));
  var maxCat  = Math.max(1, ...Object.values(byCat).map(function(v){ return v.revenue; }));
  var maxMenu = Math.max(1, ...Object.values(byMenu).map(function(v){ return v.revenue; }));

  function barRows(obj, max) {
    var entries = Object.entries(obj).sort(function(a,b){ return b[1].revenue-a[1].revenue; });
    if (!entries.length) return '<div style="color:var(--text3);font-size:13px;padding:8px 0">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
    return entries.map(function(e) {
      var name=e[0], data=e[1];
      var pct = Math.max(2, Math.round(data.revenue/max*100));
      return '<div class="chart-row">' +
        '<div class="chart-lbl" title="'+escHtml(name)+'">'+escHtml(name)+'</div>' +
        '<div class="chart-bar-bg"><div class="chart-bar-fill" style="width:'+pct+'%"></div></div>' +
        '<div class="chart-val">'+DB.fmtMoney(data.revenue)+'<br><span style="font-size:10px;color:#94A3B8">'+data.count+' l∆∞·ª£t</span></div>' +
        '</div>';
    }).join('');
  }

  document.getElementById('statsContent').innerHTML =
    '<div class="stats-grid">' +
      '<div class="stat-box"><div class="stat-num">'+cnt+'</div><div class="stat-lbl">T·ªïng l∆∞·ª£t</div></div>' +
      '<div class="stat-box"><div class="stat-num" style="font-size:16px">'+DB.fmtMoney(total)+'</div><div class="stat-lbl">Doanh thu</div></div>' +
      '<div class="stat-box"><div class="stat-num" style="font-size:16px">'+(cnt>0?DB.fmtMoney(Math.round(total/cnt)):'0‚Ç´')+'</div><div class="stat-lbl">Trung b√¨nh/l∆∞·ª£t</div></div>' +
      '<div class="stat-box"><div class="stat-num">'+Object.keys(byThr).length+'</div><div class="stat-lbl">K·ªπ thu·∫≠t vi√™n</div></div>' +
    '</div>' +
    '<div class="card"><div class="card-title">üë§ Theo k·ªπ thu·∫≠t vi√™n</div>'+barRows(byThr, maxThr)+'</div>' +
    '<div class="card"><div class="card-title">üíÜ Theo danh m·ª•c</div>'+barRows(byCat, maxCat)+'</div>' +
    '<div class="card"><div class="card-title">üèÜ Top d·ªãch v·ª•</div>' +
      (function(){
        var top = Object.entries(byMenu).sort(function(a,b){return b[1].revenue-a[1].revenue;}).slice(0,8);
        var obj = {}; top.forEach(function(e){obj[e[0]]=e[1];});
        return barRows(obj, maxMenu);
      })() +
    '</div>';
}

window.addEventListener('load', function() { init(); });
</script>
</body>
</html>
