<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Lavie Spa - Qu·∫£n L√Ω</title>
<script src="db.js"></script>
<style>
:root{--bg:#F5F7FA;--card:#fff;--border:#E2E8F0;--brown:#3E2310;--brown2:#5C3A1A;--gold:#96621A;--gold-mid:#B87D2E;--green:#16A34A;--green-l:#DCFCE7;--red:#DC2626;--red-l:#FEE2E2;--blue:#2563EB;--blue-l:#DBEAFE;--yellow:#D97706;--yellow-l:#FEF3C7;--text:#1E293B;--text2:#475569;--text3:#94A3B8;--shadow:rgba(0,0,0,.06);}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans','Segoe UI',sans-serif;min-height:100vh;}
.topbar{background:var(--brown);padding:11px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.3);}
.topbar-logo{font-size:15px;font-weight:700;color:#E8C878;}
.tnav{color:rgba(255,255,255,.65);font-size:11px;padding:5px 10px;border-radius:12px;text-decoration:none;border:1px solid transparent;}
.tnav:hover,.tnav.active{background:rgba(255,255,255,.15);color:#fff;}
.page-tabs{background:#fff;border-bottom:2px solid var(--border);display:flex;overflow-x:auto;scrollbar-width:none;padding:0 4px;}
.page-tabs::-webkit-scrollbar{display:none;}
.ptab{flex-shrink:0;padding:12px 18px;font-size:13px;font-weight:600;color:var(--text2);cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;}
.ptab.active{color:var(--gold);border-bottom-color:var(--gold);}
.page-content{padding:14px;max-width:600px;margin:0 auto;display:none;}
.page-content.active{display:block;}
.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px var(--shadow);border:1px solid var(--border);}
.card-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
/* Session cards */
.sess-card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 8px var(--shadow);border-left:4px solid var(--green);position:relative;}
.sess-card.finishing{border-left-color:var(--yellow);}
.sess-card.overtime{border-left-color:var(--red);}
.sc-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px;}
.sc-menu{font-size:14px;font-weight:700;color:var(--text);flex:1;line-height:1.3;}
.sc-amount{font-size:17px;font-weight:800;color:var(--gold);white-space:nowrap;}
.sc-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;}
.badge{font-size:11px;padding:3px 9px;border-radius:8px;font-weight:600;}
.bg{background:var(--green-l);color:var(--green);}
.bb{background:var(--blue-l);color:var(--blue);}
.by{background:var(--yellow-l);color:var(--yellow);}
.br{background:var(--red-l);color:var(--red);}
.sc-timer{font-size:28px;font-weight:800;color:var(--green);font-variant-numeric:tabular-nums;letter-spacing:-1px;margin:4px 0;}
.sc-timer.finishing{color:var(--yellow);}
.sc-timer.overtime{color:var(--red);}
/* Timer done label ‚Äî show grey after 0 */
.sc-timer.done{color:var(--text3);}
.sc-note{font-size:12px;color:var(--text2);margin-top:6px;padding:6px 10px;background:var(--bg);border-radius:8px;border-left:3px solid var(--border);}
.sc-actions{display:flex;gap:7px;margin-top:10px;flex-wrap:wrap;}
.btn-sm{padding:8px 10px;border-radius:8px;border:none;font-size:12px;font-weight:700;cursor:pointer;flex:1;min-width:80px;transition:all .15s;}
.btn-complete{background:var(--green);color:#fff;}
.btn-note-ed{background:var(--blue-l);color:var(--blue);border:1px solid var(--blue);}
.btn-cancel-s{background:var(--red-l);color:var(--red);border:1px solid var(--red);}
/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px;}
.stat-box{background:var(--card);border-radius:11px;padding:12px 10px;box-shadow:0 2px 6px var(--shadow);text-align:center;border:1px solid var(--border);}
.stat-num{font-size:20px;font-weight:800;color:var(--gold);line-height:1.2;}
.stat-lbl{font-size:11px;color:var(--text3);margin-top:3px;}
/* Payment stats */
.pay-split{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
.pay-box{border-radius:10px;padding:12px;text-align:center;}
.pay-cash{background:var(--green-l);border:1.5px solid var(--green);}
.pay-bank{background:var(--blue-l);border:1.5px solid var(--blue);}
.pay-num{font-size:17px;font-weight:800;}
.pay-cash .pay-num{color:var(--green);}
.pay-bank .pay-num{color:var(--blue);}
.pay-lbl{font-size:11px;font-weight:600;margin-top:2px;}
.pay-cash .pay-lbl{color:var(--green);}
.pay-bank .pay-lbl{color:var(--blue);}
/* Filter */
.filter-row{display:flex;gap:7px;margin-bottom:12px;flex-wrap:wrap;}
.fbtn{padding:6px 13px;border-radius:16px;border:1.5px solid var(--border);background:var(--card);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;}
.fbtn.active{background:var(--gold);border-color:var(--gold);color:#fff;}
/* Record */
.rec-item{background:var(--card);border-radius:10px;padding:11px 13px;margin-bottom:7px;box-shadow:0 1px 4px var(--shadow);border:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.rec-info{flex:1;}
.rec-menu{font-size:13px;font-weight:700;color:var(--text);}
.rec-meta{font-size:11px;color:var(--text2);margin-top:2px;line-height:1.5;}
.rec-note{font-size:11px;color:var(--blue);margin-top:3px;padding:4px 7px;background:var(--blue-l);border-radius:5px;font-style:italic;}
.rec-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
.rec-amount{font-size:15px;font-weight:800;color:var(--gold);white-space:nowrap;}
.pay-tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:6px;white-space:nowrap;}
.pay-tag.cash{background:var(--green-l);color:var(--green);}
.pay-tag.bank{background:var(--blue-l);color:var(--blue);}
/* Chart */
.chart-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.chart-lbl{font-size:11.5px;color:var(--text2);width:110px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;}
.chart-bar-bg{flex:1;background:var(--border);border-radius:4px;height:18px;overflow:hidden;}
.chart-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold-mid),var(--gold));border-radius:4px;transition:width .5s ease;min-width:2px;}
.chart-val{font-size:11px;font-weight:700;color:var(--gold);width:80px;flex-shrink:0;}
/* Row */
.sec-hdr-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.sec-hdr-title{font-size:15px;font-weight:700;color:var(--text);}
.btn-add-link{padding:7px 13px;border-radius:8px;background:var(--gold);color:#fff;border:none;font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;}
.export-btn{padding:7px 13px;border-radius:8px;background:var(--blue-l);color:var(--blue);border:1px solid var(--blue);font-size:12px;font-weight:600;cursor:pointer;}
/* Empty */
.empty-s{text-align:center;padding:40px 20px;color:var(--text3);}
.empty-ico{font-size:48px;margin-bottom:12px;}
/* Loading */
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;}
.loading-logo{font-size:22px;font-weight:700;color:var(--brown);margin-bottom:16px;}
.spin{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--gold-mid);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:500;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.show{display:flex;}
.modal-box{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:380px;animation:popIn .2s ease;}
@keyframes popIn{from{opacity:0;transform:scale(.93)}to{opacity:1;transform:scale(1)}}
.modal-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:14px;}
.field-lbl{font-size:12px;font-weight:700;color:var(--text2);margin:10px 0 4px;}
.field-input{width:100%;padding:10px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;color:var(--text);background:#fff;}
.field-input:focus{outline:none;border-color:var(--gold);}
.modal-btn-row{display:flex;gap:8px;margin-top:14px;}
.btn-primary{flex:1;padding:11px;border-radius:9px;background:var(--gold);color:#fff;font-size:14px;font-weight:700;border:none;cursor:pointer;}
.btn-secondary{flex:1;padding:11px;border-radius:9px;background:var(--bg);color:var(--text2);font-size:14px;font-weight:600;border:1.5px solid var(--border);cursor:pointer;}
/* Payment option buttons */
.pay-opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;}
.pay-opt{padding:16px 10px;border-radius:12px;border:2.5px solid var(--border);background:var(--bg);font-size:15px;font-weight:700;cursor:pointer;text-align:center;transition:all .15s;}
.pay-opt.cash.selected{background:var(--green-l);border-color:var(--green);color:var(--green);}
.pay-opt.bank.selected{background:var(--blue-l);border-color:var(--blue);color:var(--blue);}
.pay-opt:hover{border-color:var(--gold);}
</style>
</head>
<body>
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">üåø Lavie Spa</div>
  <div class="spin"></div>
  <div style="margin-top:12px;color:var(--text3);font-size:13px">ƒêang t·∫£i...</div>
</div>
<div id="appBody" style="display:none">
<div class="topbar">
  <div class="topbar-logo">üåø Lavie Spa - Qu·∫£n L√Ω</div>
  <div style="display:flex;gap:4px">
    <a class="tnav" href="index.html">üìã Menu</a>
    <a class="tnav active" href="admin.html">‚öôÔ∏è Qu·∫£n l√Ω</a>
    <a class="tnav" href="settings.html">üõ† C√†i ƒë·∫∑t</a>
  </div>
</div>
<div class="page-tabs">
  <div class="ptab active" onclick="showPage('live')">üü¢ ƒêang th·ª±c hi·ªán</div>
  <div class="ptab" onclick="showPage('records')">üìã L·ªãch s·ª≠</div>
  <div class="ptab" onclick="showPage('stats')">üìä Th·ªëng k√™</div>
</div>
<div id="page-live" class="page-content active">
  <div class="sec-hdr-row">
    <div class="sec-hdr-title">D·ªãch v·ª• ƒëang ch·∫°y</div>
    <a class="btn-add-link" href="index.html">+ Th√™m</a>
  </div>
  <div id="liveList"></div>
</div>
<div id="page-records" class="page-content">
  <div class="sec-hdr-row">
    <div class="sec-hdr-title">L·ªãch s·ª≠ d·ªãch v·ª•</div>
    <button class="export-btn" onclick="exportRecords()">üì• Xu·∫•t Excel</button>
  </div>
  <div class="filter-row">
    <button class="fbtn active" onclick="setRecF('day',this)">H√¥m nay</button>
    <button class="fbtn" onclick="setRecF('week',this)">Tu·∫ßn</button>
    <button class="fbtn" onclick="setRecF('month',this)">Th√°ng</button>
    <button class="fbtn" onclick="setRecF('year',this)">NƒÉm</button>
    <button class="fbtn" onclick="setRecF('all',this)">T·∫•t c·∫£</button>
  </div>
  <div id="recSummary"></div>
  <div id="recList"></div>
</div>
<div id="page-stats" class="page-content">
  <div class="filter-row">
    <button class="fbtn active" onclick="setStatF('day',this)">H√¥m nay</button>
    <button class="fbtn" onclick="setStatF('week',this)">Tu·∫ßn</button>
    <button class="fbtn" onclick="setStatF('month',this)">Th√°ng</button>
    <button class="fbtn" onclick="setStatF('year',this)">NƒÉm</button>
    <button class="fbtn" onclick="setStatF('all',this)">T·∫•t c·∫£</button>
  </div>
  <div id="statsContent"></div>
</div>
</div>

<!-- Note Modal -->
<div class="modal-overlay" id="noteModal" onclick="if(event.target===this)closeNoteModal()">
  <div class="modal-box">
    <div class="modal-title">üìù Ghi ch√∫</div>
    <div class="field-lbl">N·ªôi dung</div>
    <input class="field-input" id="noteInput" type="text" placeholder="Nh·∫≠p ghi ch√∫...">
    <div class="modal-btn-row">
      <button class="btn-secondary" onclick="closeNoteModal()">H·ªßy</button>
      <button class="btn-primary" onclick="saveNote()">L∆∞u</button>
    </div>
  </div>
</div>

<!-- Complete + Payment Modal -->
<div class="modal-overlay" id="completeModal" onclick="if(event.target===this)closeCompleteModal()">
  <div class="modal-box">
    <div class="modal-title">‚úÖ Ho√†n th√†nh d·ªãch v·ª•</div>
    <div id="completeMenuInfo" style="font-size:13px;color:var(--text2);margin-bottom:4px;"></div>
    <div style="font-size:18px;font-weight:800;color:var(--gold);margin-bottom:10px" id="completeAmount"></div>
    <div class="field-lbl">üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</div>
    <div class="pay-opts">
      <div class="pay-opt cash" id="pay-cash" onclick="selPayment('cash')">üíµ<br>Ti·ªÅn m·∫∑t</div>
      <div class="pay-opt bank" id="pay-bank" onclick="selPayment('bank')">üè¶<br>Chuy·ªÉn kho·∫£n</div>
    </div>
    <div class="field-lbl">Ghi ch√∫ cu·ªëi (tu·ª≥ ch·ªçn)</div>
    <input class="field-input" id="completeFinalNote" type="text" placeholder="">
    <div class="modal-btn-row">
      <button class="btn-secondary" onclick="closeCompleteModal()">H·ªßy</button>
      <button class="btn-primary" id="completeSaveBtn" onclick="doComplete()">‚úÖ L∆∞u & Ho√†n th√†nh</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }         from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
         collection, getDocs, query, orderBy, onSnapshot, addDoc }
  from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const app = initializeApp(DB.FIREBASE_CONFIG);
const fs  = getFirestore(app);

let appData = { categories:[], menus:[], therapists:[], beds:[], sessions:[], records:[] };
let recF = 'day', statF = 'day';
let editSessId = null;
let completeSessId = null, selPayMethod = null;

// ‚îÄ‚îÄ Load all ‚îÄ‚îÄ
async function loadAll() {
  const [configSnap, thrSnap, recSnap] = await Promise.all([
    getDoc(doc(fs,'config','main')),
    getDocs(collection(fs,'therapists')),
    getDocs(collection(fs,'records'))
  ]);
  if(configSnap.exists()){
    const cfg=configSnap.data();
    appData.categories=cfg.categories||[];
    appData.menus=cfg.menus||[];
    appData.beds=cfg.beds||[];
  }
  appData.therapists = thrSnap.docs.map(d=>d.data());
  appData.records    = recSnap.docs.map(d=>d.data());

  // Live sessions listener
  onSnapshot(collection(fs,'sessions'), snap => {
    appData.sessions = snap.docs.map(d=>d.data()).filter(s=>s.status==='active');
    renderLive();
  });

  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('appBody').style.display='block';
  startTimerLoop();
  renderRecords();
  renderStats();
}

// ‚îÄ‚îÄ Page tabs ‚îÄ‚îÄ
window.showPage = function(name){
  ['live','records','stats'].forEach(p=>{
    document.getElementById('page-'+p).classList.toggle('active',p===name);
  });
  document.querySelectorAll('.ptab').forEach((t,i)=>t.classList.toggle('active',['live','records','stats'][i]===name));
  if(name==='records'){
    // refresh records from Firestore
    getDocs(collection(fs,'records')).then(snap=>{
      appData.records=snap.docs.map(d=>d.data());
      renderRecords();
    });
  }
  if(name==='stats'){
    getDocs(collection(fs,'records')).then(snap=>{
      appData.records=snap.docs.map(d=>d.data());
      renderStats();
    });
  }
};

// ‚îÄ‚îÄ Live sessions ‚îÄ‚îÄ
function renderLive(){
  const sessions=(appData.sessions||[]).filter(s=>s.status==='active');
  const el=document.getElementById('liveList');
  if(!sessions.length){
    el.innerHTML=`<div class="empty-s"><div class="empty-ico">üõèÔ∏è</div><div>Ch∆∞a c√≥ d·ªãch v·ª• ƒëang th·ª±c hi·ªán.<br>V√†o <a href="index.html" style="color:var(--gold)">B·∫£ng gi√°</a> ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div></div>`;
    return;
  }
  el.innerHTML=sessions.map(s=>{
    const rem=s.endTime?s.endTime-Date.now():null;
    let cc='';
    if(rem!==null){cc=rem<0?'overtime':rem<300000?'finishing':'';}
    return `<div class="sess-card ${cc}" id="sc_${s.id}">
      <div class="sc-top"><div class="sc-menu">${DB.escHtml(s.menuNameVi)}</div><div class="sc-amount">${DB.fmtMoney(s.amount)}</div></div>
      <div class="sc-meta">
        <span class="badge bg">üë§ ${DB.escHtml(s.therapistName||'‚Äî')}</span>
        ${s.bedName?`<span class="badge bb">üõè ${DB.escHtml(s.bedName)}</span>`:''}
        <span class="badge by">üïê ${DB.fmtTime(s.startTime)}</span>
        ${s.endTime?`<span class="badge ${cc==='overtime'?'br':'bb'}">‚è∞ ${DB.fmtTime(s.endTime)}</span>`:''}
      </div>
      <div class="sc-timer" id="timer_${s.id}">--:--</div>
      ${s.note?`<div class="sc-note">üìù ${DB.escHtml(s.note)}</div>`:''}
      <div class="sc-actions">
        <button class="btn-sm btn-complete" onclick="openCompleteModal('${s.id}')">‚úÖ Ho√†n th√†nh</button>
        <button class="btn-sm btn-note-ed"  onclick="openNoteModal('${s.id}')">üìù Ghi ch√∫</button>
        <button class="btn-sm btn-cancel-s" onclick="cancelSession('${s.id}')">‚úï H·ªßy</button>
      </div>
    </div>`;
  }).join('');
  updateTimers();
}

function startTimerLoop(){ setInterval(updateTimers,1000); }
function pad(n){return String(n).padStart(2,'0');}

function updateTimers(){
  (appData.sessions||[]).filter(s=>s.status==='active').forEach(s=>{
    const el=document.getElementById('timer_'+s.id);
    const card=document.getElementById('sc_'+s.id);
    if(!el) return;
    const now=Date.now();
    let txt='',cls='';
    if(s.endTime){
      const rem=s.endTime-now;
      if(rem>0){
        // Counting down
        txt=pad(Math.floor(rem/60000))+':'+pad(Math.floor((rem%60000)/1000));
        cls=rem<300000?'finishing':'';
        if(card){card.className='sess-card'+(rem<300000?' finishing':'');}
      } else {
        // Timer ended ‚Äî show "ƒê√£ xong" and freeze, but card stays until completed
        const over=Math.floor(-rem/60000);
        txt='ƒê√£ xong +'+over+'ph';
        cls='done';
        if(card){card.className='sess-card overtime';}
      }
    } else {
      txt=Math.floor((now-s.startTime)/60000)+' ph√∫t';
    }
    el.textContent=txt;
    el.className='sc-timer '+cls;
  });
}

// ‚îÄ‚îÄ Complete + Payment ‚îÄ‚îÄ
window.openCompleteModal = function(id){
  completeSessId=id; selPayMethod=null;
  const s=(appData.sessions||[]).find(x=>x.id===id);
  if(!s) return;
  document.getElementById('completeMenuInfo').textContent=s.menuNameVi+' ‚Äî '+s.therapistName+(s.bedName?' | '+s.bedName:'');
  document.getElementById('completeAmount').textContent=DB.fmtMoney(s.amount);
  document.getElementById('completeFinalNote').value=s.note||'';
  document.getElementById('pay-cash').classList.remove('selected');
  document.getElementById('pay-bank').classList.remove('selected');
  document.getElementById('completeModal').classList.add('show');
};
window.closeCompleteModal=function(){document.getElementById('completeModal').classList.remove('show');completeSessId=null;selPayMethod=null;};
window.selPayment=function(m){
  selPayMethod=m;
  document.getElementById('pay-cash').classList.toggle('selected',m==='cash');
  document.getElementById('pay-bank').classList.toggle('selected',m==='bank');
};
window.doComplete=async function(){
  if(!completeSessId){return;}
  if(!selPayMethod){alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!');return;}
  const s=(appData.sessions||[]).find(x=>x.id===completeSessId);
  if(!s) return;
  const finalNote=document.getElementById('completeFinalNote').value.trim();
  const record={
    ...s,
    status:'completed',
    completedTime:Date.now(),
    paymentMethod:selPayMethod,
    note:finalNote||s.note||''
  };
  await setDoc(doc(fs,'records',record.id),record);
  await deleteDoc(doc(fs,'sessions',s.id));
  closeCompleteModal();
  appData.records.push(record);
};

window.cancelSession=async function(id){
  if(!confirm('H·ªßy d·ªãch v·ª• n√†y? (Kh√¥ng t√≠nh doanh thu)')) return;
  const s=(appData.sessions||[]).find(x=>x.id===id);
  if(!s) return;
  const record={...s,status:'cancelled',completedTime:Date.now(),amount:0,paymentMethod:'none'};
  await setDoc(doc(fs,'records',record.id),record);
  await deleteDoc(doc(fs,'sessions',s.id));
};

// ‚îÄ‚îÄ Note edit ‚îÄ‚îÄ
window.openNoteModal=function(id){
  editSessId=id;
  const s=(appData.sessions||[]).find(x=>x.id===id);
  document.getElementById('noteInput').value=s?.note||'';
  document.getElementById('noteModal').classList.add('show');
  setTimeout(()=>document.getElementById('noteInput').focus(),100);
};
window.closeNoteModal=function(){document.getElementById('noteModal').classList.remove('show');editSessId=null;};
window.saveNote=async function(){
  if(!editSessId) return;
  const note=document.getElementById('noteInput').value.trim();
  await updateDoc(doc(fs,'sessions',editSessId),{note});
  closeNoteModal();
};

// ‚îÄ‚îÄ Records ‚îÄ‚îÄ
function getRange(f){
  const now=new Date(),from=new Date();
  if(f==='day'){from.setHours(0,0,0,0);}
  else if(f==='week'){from.setDate(now.getDate()-now.getDay());from.setHours(0,0,0,0);}
  else if(f==='month'){from.setDate(1);from.setHours(0,0,0,0);}
  else if(f==='year'){from.setMonth(0,1);from.setHours(0,0,0,0);}
  else return null;
  return{from:from.getTime(),to:Date.now()};
}
function getRecords(f){
  const all=(appData.records||[]).filter(r=>r.status==='completed');
  const range=getRange(f);
  if(!range) return all;
  return all.filter(r=>{const ts=r.completedTime||r.startTime;return ts>=range.from&&ts<=range.to;});
}

window.setRecF=function(f,btn){
  recF=f;
  document.querySelectorAll('#page-records .fbtn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderRecords();
};
window.setStatF=function(f,btn){
  statF=f;
  document.querySelectorAll('#page-stats .fbtn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderStats();
};

function payLabel(m){
  if(m==='cash') return '<span class="pay-tag cash">üíµ Ti·ªÅn m·∫∑t</span>';
  if(m==='bank') return '<span class="pay-tag bank">üè¶ Chuy·ªÉn kho·∫£n</span>';
  return '';
}

function renderRecords(){
  const recs=getRecords(recF).sort((a,b)=>(b.completedTime||b.startTime)-(a.completedTime||a.startTime));
  const total=recs.reduce((s,r)=>s+(r.amount||0),0);
  const cash =recs.filter(r=>r.paymentMethod==='cash').reduce((s,r)=>s+(r.amount||0),0);
  const bank =recs.filter(r=>r.paymentMethod==='bank').reduce((s,r)=>s+(r.amount||0),0);

  document.getElementById('recSummary').innerHTML=`
    <div class="stats-grid">
      <div class="stat-box"><div class="stat-num">${recs.length}</div><div class="stat-lbl">L∆∞·ª£t d·ªãch v·ª•</div></div>
      <div class="stat-box"><div class="stat-num" style="font-size:16px">${DB.fmtMoney(total)}</div><div class="stat-lbl">T·ªïng doanh thu</div></div>
    </div>
    <div class="pay-split">
      <div class="pay-box pay-cash"><div class="pay-num">${DB.fmtMoney(cash)}</div><div class="pay-lbl">üíµ Ti·ªÅn m·∫∑t</div></div>
      <div class="pay-box pay-bank"><div class="pay-num">${DB.fmtMoney(bank)}</div><div class="pay-lbl">üè¶ Chuy·ªÉn kho·∫£n</div></div>
    </div>`;

  if(!recs.length){document.getElementById('recList').innerHTML='<div class="empty-s"><div class="empty-ico">üìã</div><div>Ch∆∞a c√≥ d·ªØ li·ªáu.</div></div>';return;}
  document.getElementById('recList').innerHTML=recs.map(r=>`
    <div class="rec-item">
      <div class="rec-info">
        <div class="rec-menu">${DB.escHtml(r.menuNameVi)}</div>
        <div class="rec-meta">üë§ ${DB.escHtml(r.therapistName||'‚Äî')}${r.bedName?' | üõè '+DB.escHtml(r.bedName):''} | üïê ${DB.fmtDateTime(r.completedTime||r.startTime)}${r.duration?' | ‚è± '+r.duration+'ph':''}</div>
        ${r.note?`<div class="rec-note">üìù ${DB.escHtml(r.note)}</div>`:''}
      </div>
      <div class="rec-right">
        <div class="rec-amount">${DB.fmtMoney(r.amount)}</div>
        ${payLabel(r.paymentMethod)}
      </div>
    </div>`).join('');
}

window.exportRecords=function(){
  const recs=getRecords(recF);
  DB.exportToCSV('laviespa_lichsu_'+new Date().toISOString().slice(0,10)+'.csv',
    ['Th·ªùi gian','D·ªãch v·ª•','K·ªπ thu·∫≠t vi√™n','Gi∆∞·ªùng','Th·ªùi l∆∞·ª£ng','Doanh thu','Thanh to√°n','Ghi ch√∫'],
    recs.map(r=>[DB.fmtDateTime(r.completedTime||r.startTime),r.menuNameVi,r.therapistName||'',r.bedName||'',r.duration?r.duration+' ph√∫t':'',r.amount||0,r.paymentMethod==='cash'?'Ti·ªÅn m·∫∑t':r.paymentMethod==='bank'?'Chuy·ªÉn kho·∫£n':'',r.note||''])
  );
};

function renderStats(){
  const recs=getRecords(statF);
  const total=recs.reduce((s,r)=>s+(r.amount||0),0);
  const cnt=recs.length;
  const cash=recs.filter(r=>r.paymentMethod==='cash').reduce((s,r)=>s+(r.amount||0),0);
  const bank=recs.filter(r=>r.paymentMethod==='bank').reduce((s,r)=>s+(r.amount||0),0);

  const byThr={}, byCat={}, byMenu={}, byPay={'Ti·ªÅn m·∫∑t':{count:0,revenue:0},'Chuy·ªÉn kho·∫£n':{count:0,revenue:0}};
  recs.forEach(r=>{
    const tk=r.therapistName||'Kh√¥ng r√µ';
    if(!byThr[tk]){byThr[tk]={count:0,revenue:0};}byThr[tk].count++;byThr[tk].revenue+=r.amount||0;
    const cat=appData.categories.find(c=>c.id===r.catId);
    const ck=cat?cat.nameVi:(r.catNameVi||'Kh√°c');
    if(!byCat[ck]){byCat[ck]={count:0,revenue:0};}byCat[ck].count++;byCat[ck].revenue+=r.amount||0;
    const mk=r.menuNameVi||'Kh√°c';
    if(!byMenu[mk]){byMenu[mk]={count:0,revenue:0};}byMenu[mk].count++;byMenu[mk].revenue+=r.amount||0;
    if(r.paymentMethod==='cash'){byPay['Ti·ªÅn m·∫∑t'].count++;byPay['Ti·ªÅn m·∫∑t'].revenue+=r.amount||0;}
    else if(r.paymentMethod==='bank'){byPay['Chuy·ªÉn kho·∫£n'].count++;byPay['Chuy·ªÉn kho·∫£n'].revenue+=r.amount||0;}
  });

  function barRows(obj,max,colorVar){
    const entries=Object.entries(obj).sort((a,b)=>b[1].revenue-a[1].revenue);
    if(!entries.length) return '<div style="color:var(--text3);font-size:13px;padding:8px 0">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
    return entries.map(([name,data])=>{
      const pct=Math.max(2,Math.round(data.revenue/max*100));
      return `<div class="chart-row">
        <div class="chart-lbl" title="${DB.escHtml(name)}">${DB.escHtml(name)}</div>
        <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%;background:${colorVar||'linear-gradient(90deg,var(--gold-mid),var(--gold))'}"></div></div>
        <div class="chart-val">${DB.fmtMoney(data.revenue)}<br><span style="font-size:10px;color:#94A3B8">${data.count} l∆∞·ª£t</span></div>
      </div>`;
    }).join('');
  }

  const maxThr=Math.max(1,...Object.values(byThr).map(v=>v.revenue));
  const maxCat=Math.max(1,...Object.values(byCat).map(v=>v.revenue));
  const maxMenu=Math.max(1,...Object.values(byMenu).map(v=>v.revenue));

  document.getElementById('statsContent').innerHTML=`
    <div class="stats-grid">
      <div class="stat-box"><div class="stat-num">${cnt}</div><div class="stat-lbl">T·ªïng l∆∞·ª£t</div></div>
      <div class="stat-box"><div class="stat-num" style="font-size:16px">${DB.fmtMoney(total)}</div><div class="stat-lbl">Doanh thu</div></div>
      <div class="stat-box"><div class="stat-num" style="font-size:16px">${cnt>0?DB.fmtMoney(Math.round(total/cnt)):'0‚Ç´'}</div><div class="stat-lbl">Trung b√¨nh/l∆∞·ª£t</div></div>
      <div class="stat-box"><div class="stat-num">${Object.keys(byThr).length}</div><div class="stat-lbl">K·ªπ thu·∫≠t vi√™n</div></div>
    </div>
    <div class="pay-split">
      <div class="pay-box pay-cash"><div class="pay-num">${DB.fmtMoney(cash)}</div><div class="pay-lbl">üíµ Ti·ªÅn m·∫∑t</div><div style="font-size:10px;color:var(--green)">${byPay['Ti·ªÅn m·∫∑t'].count} l∆∞·ª£t</div></div>
      <div class="pay-box pay-bank"><div class="pay-num">${DB.fmtMoney(bank)}</div><div class="pay-lbl">üè¶ Chuy·ªÉn kho·∫£n</div><div style="font-size:10px;color:var(--blue)">${byPay['Chuy·ªÉn kho·∫£n'].count} l∆∞·ª£t</div></div>
    </div>
    <div class="card"><div class="card-title">üë§ Theo k·ªπ thu·∫≠t vi√™n</div>${barRows(byThr,maxThr)}</div>
    <div class="card"><div class="card-title">üíÜ Theo danh m·ª•c</div>${barRows(byCat,maxCat)}</div>
    <div class="card"><div class="card-title">üèÜ Top d·ªãch v·ª•</div>${barRows(Object.fromEntries(Object.entries(byMenu).sort((a,b)=>b[1].revenue-a[1].revenue).slice(0,8)),maxMenu)}</div>`;
}

loadAll();
</script>
</body>
</html>
